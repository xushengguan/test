<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>家长信息</title>
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<link rel="stylesheet" href="../../css/api.css">
	<link rel="stylesheet" href="../../css/common.css">
	<link rel="stylesheet" type="text/css" href="../../css/loading.css" />
	<link rel="stylesheet" href="../../icon/iconfonts/iconfont.css">
	<link rel="stylesheet" href="../../css/7account2.css">
</head>

<body>
	<!-- 办公地址 -->
	<div class="account2-con">
		<p class="office-con">
			<span>办公地址</span>
			<input type="text" placeholder="填写您的办公地址" id="address">
		</p>
		<p class="office-con">
			<span>主营业务</span>
			<input type="text" placeholder="公司的主营业务" id="business">
		</p>
		<p class="office-con">
			<span>场地面积</span>
			<input type="text" placeholder="可使用面积" id="area">
		</p>
		<p class="office-con">
			<span>团队人数</span>
			<input type="text" placeholder="团队总人数" id="team">
		</p>
		<p class="office-con">
			<span>行业资源</span>
			<input type="text" placeholder="您拥有的行业资源" id="resource">
		</p>
		<p class="license-con">
			<span>上传营业执照</span>
			<i class="iconfont icon-tianjiatupian icon-license" style="margin-left:10px;" onclick="sel_picture()"></i>
			<img src="" alt="" id="img" style="display:none; margin-left:10px; width:60px; height:60px;">
		</p>
	</div>
	<div class="read-con">
		<div class="hide read-top">
			<i class="iconfont icon-square fl"></i>
			<i class="iconfont icon-right" style="font-size:7px;"></i>
			<p class="fl agree">已阅读并同意<span style="color:#4c5be5;">《xxx认证协议》</span></p>
		</div>
		<p class="save-btn"><button onclick="save()">保存</button></p>
	</div>

</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/my.js"></script>

<script type="text/javascript">
	var id, imgUrl, url;
	apiready = function() {
		loading();
		id = api.pageParam.id; //用户ID

	}

	//保存
	function save() {
		$api.css($api.dom('#loading'),'display:block');
		var address = $api.val($api.dom("#address"));
		var business = $api.val($api.dom("#business"));
		var area = $api.val($api.dom("#area"));
		var team = $api.val($api.dom("#team"));
		var resource = $api.val($api.dom("#resource"));

		api.ajax({ //完善商家信息
			url: serverurl,
			method: 'get',
			dataType: 'json',
			data: {
				values: {
					type: '10008',
					uid: id,
					address: address,
					business: business,
					area: area,
					team: team,
					resource: resource,
					img: url
				}
			}
		}, function(ret, err) {
			$api.css($api.dom('#loading'),'display:none');

			if (ret) {
				if (ret.status == '1') { //1成功
					api.toast({
						msg: '保存成功',
						duration: 2000,
						location: 'middle'
					});
					go_back();
				} else {
					api.toast({
						msg: '操作失败',
						duration: 2000,
						location: 'middle'
					});
				}
			} else {
				api.alert({
					msg: JSON.stringify(err)
				});
			}
		});
	}

	//选取图片
	function sel_picture() {
		api.getPicture({
			sourceType: 'camera',
			encodingType: 'jpg',
			mediaValue: 'pic',
			destinationType: 'url',
			allowEdit: true,
			quality: 50,
			targetWidth: 100,
			targetHeight: 100,
			saveToPhotoAlbum: false
		}, function(ret, err) {
			if (ret) {
				imgUrl = ret.data;
				uploader();
			} else {
				api.toast({
				    msg: '网络错误',
				    duration: 2000,
				    location: 'middle'
				});

			}
		});
	}

	//获取阿里云签名
	function uploader() {
		$api.css($api.dom('#loading'),'display:block');
		api.ajax({
			url: 'https://x.sdp178.com/service/api.php',
			method: 'post',
			data: {
				values: {
					type: '10098',
				}
			}
		}, function(ret, err) {
			if (ret) {

				var host = ret.host;
				var policy = ret.policy;
				var signature = ret.signature;
				var accessid = ret.accessid;
				var dir = ret.dir;
				var expire = ret.expire;
				ALIcloud(host, policy, signature, accessid, dir, expire);

			} else {
				api.toast({
				    msg: '网络错误',
				    duration: 2000,
				    location: 'middle'
				});
			}
		});
	}

	function ALIcloud(host, policy, signature, accessid, dir, expire) {
		//将图片上传给阿里云服务器
		api.ajax({ //完善班主任信息
			url: host,
			method: 'post',
			dataType: 'xml',
			data: {
				values: {
					OSSAccessKeyId: accessid,
					policy: policy,
					Signature: signature,
					key: dir,
					success_action_status: 201
				},
				files: {
					file: imgUrl
				}
			}
		}, function(ret, err) {
			if (ret) {
				// 在你回调函数里面调用
				var dom = parseXML(ret);
				// location 标签的内容使用DOM选择器进行查找
				url = dom.querySelector('Location').innerHTML;
				$api.css($api.dom('.license-con i'), 'display:none');
				$api.attr($api.dom('#img'), 'src', url);
				$api.css($api.dom('#img'), 'display:inline-block');
				$api.css($api.dom('#loading'),'display:none');

			} else {
				api.toast({
				    msg: '网络错误',
				    duration: 2000,
				    location: 'middle'
				});
			}
		});
	}
</script>
