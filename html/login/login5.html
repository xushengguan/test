<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
      <title>关联</title>
      <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
      <link rel="stylesheet" type="text/css" href="../../css/loading.css"/>
      <style>
          .content{height: 100%; background: #fff; padding: 0 25px;}
          header{padding: 70px 0 45px 0; text-align: center; position: relative; font-size: 25px; font-weight: bold; color: #212121;}
          header em{position: absolute; left: 0; top: 30px; width: 12px; height: 22px; background:url(../../image/goback.png) no-repeat center;
          background-size: 12px 22px;}
          .line{width: 100%; position: relative; margin-bottom: 25px;}
          .line input,.address{height: 35px; line-height: 35px; width: 100%; font-size: 16px; color: #212121; border-bottom: 1px solid #d8d8d8;}
          .line input:focus{border-bottom: 1px solid #ffb300;}
          .line input.password{width: calc(100% - 25px); padding-right: 25px;}
          .line input.code{width: calc(100% - 30%);}
          .line button{width: 25%; height: 35px; line-height: 35px; border-radius: 3px; border: 1px solid #ffb300; text-align: center;
          font-size: 14px; color: #ffb300; float: right;}
          .line em{width: 25px; height: 35px; position: absolute;  top: 0; right: 0; background: url(../../image/eye1.png) center no-repeat;
          background-size: 22px 18px;}
          .line em.on{background: url(../../image/eye2.png) center no-repeat; background-size: 22px 16px;}
          .next{width: 100%; height: 43px; line-height: 43px; border-radius: 3px; background: #b1b1b1; text-align: center;
          color: #fff; font-size: 18px; margin-top: 30px;}
          .next.on{background: #ffb300;}

          .bg{width: 185px; height: 157px; background: url(../../image/login_bg.png) no-repeat center; background-size: 185px 157px;
          position: absolute; bottom: 0; right: 0;}

          .RealName{margin-top: 8px; text-align: center; font-size: 16px; }
          .RealName span{color: #09bb07; font-weight: bold;}

          .address em{width: 8px; height: 15px; position: absolute; top: 10px; right: 0; background: url(../../image/rt.png) no-repeat center;
          background-size: 8px 15px;}

          .pic img{width: 75px; height: 75px; margin-right: 8px;}
          .prompt{float:right; width: calc(100% - 170px);}
          .prompt .title{font-size: 16px; color: #333;}
          .prompt .care{font-size: 13px; color: #c0c0c0;}

          .code{width: 100%; height: 171px; background: url(../../image/code.png) no-repeat center; background-size: 221px 171px;}
          .txt{margin-top: 50px; font-size: 16px; color: #c0c0c0; text-align: center;}
      </style>
  </head>
  <body>
      <!-- 学生家长 -->
      <!-- <div class="content" style="display:none">
          <header>
              <em></em>
              最后一步
              <div class="RealName">关联<span>学生</span>信息</div>
          </header>

          <div class="line">
              <input class="tel" type="text" placeholder="填写学生姓名">
          </div>
          <div class="line">
              <input class="tel" type="text" placeholder="学生所在学校(选填)">
          </div>
          <div class="line address">
              <em></em>
              所处年级(选填)
          </div>

          <button class="next on">完成注册</button>
    </div> -->

    <!-- 支教老师 -->
    <div class="content">
        <header>
            <em tapmode onclick="go_back()"></em>
            关联学令牌
        </header>

        <div class="code"></div>
        <div class="txt">请扫描学令牌包装上的二维码完成绑定</div>

        <button class="next on" tapmode onclick="scan()">开始扫码绑定</button>

    </div>
  </body>
  <script type="text/javascript" src="../../script/api.js"></script>
  <script type="text/javascript" src="../../script/my.js"></script>
  <script type="text/javascript">
      var id,token;
      var header = $api.dom('header');
  		fixStatusBar_API(header);
      apiready = function(){
          id = $api.getStorage('id');
          token = $api.getStorage('token');
          loading();
      };

      // 扫描二维码
      function scan(){
        var FNScanner = api.require('FNScanner');
        FNScanner.openScanner({
            autorotation: true
        }, function(ret, err) {

            if (ret) {
                if (ret.eventType == 'success') {
                      var key = ret.content;
                      api.confirm({
                         title: '关联提示',
                         msg: '激活码正确，是否激活捆绑'+key+'产品?',
                         buttons: ['确定', '取消']
                      }, function(ret, err) {
                         var index = ret.buttonIndex;
                         if (index == 1) {
                             BindCard(key);
                         }else {
                             api.toast({
                                 msg: '请关联您的学令牌',
                                 duration: 2000,
                                 location: 'middle'
                             });

                         }
                      });


                }else if (ret.eventType == 'fail') {
                    api.toast({
                        msg: '扫描失败',
                        duration: 2000,
                        location: 'middle'
                    });

                }
            } else {
                api.toast({
                    msg: err,
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
      }

      // 绑定学令牌
      function BindCard(key){
          api.ajax({
              url: serverurl,
              method: 'get',
              data: {
                  values: {
                       type: '10147',
                       uid:id,
                       key:key
                  },
              }
          },function(ret, err){
              if (ret) {
                  if (ret.status == '1') {
                      $api.setStorage('activate_status','1');//是否激活学令牌 支教老师 0:不是 1：是
                      api.toast({
                          msg: '关联成功',
                          duration: 2000,
                          location: 'middle'
                      });
                      api.openWin({
                          name: 'index',
                          url: '../../index.html',
                          reload:true
                      });
                  }else if (ret.status == '3') {
                      api.toast({
                          msg: '产品不存在',
                          duration: 2000,
                          location: 'middle'
                      });
                  }else {
                      api.toast({
                          msg: '关联失败',
                          duration: 2000,
                          location: 'middle'
                      });

                  }
              } else {

                  api.toast({
                      msg: '网络错误',
                      duration: 2000,
                      location: 'bottom'
                  });

              }
          });

      }
  </script>
  </html>
