<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
      <title>找回密码</title>
      <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
      <link rel="stylesheet" type="text/css" href="../../css/loading.css"/>
      <style>
          .content{height: 100%; background: #fff; padding: 0 25px;}
          header{padding: 70px 0 45px 0; text-align: center; position: relative; font-size: 25px; font-weight: bold; color: #212121;}
          header em{position: absolute; left: 0; top: 30px; width: 12px; height: 22px; background:url(../../image/goback.png) no-repeat center;
          background-size: 12px 22px;}
          .line{width: 100%; position: relative; margin-bottom: 25px;}
          .line input{height: 35px; line-height: 35px; width: 100%; font-size: 16px; color: #212121; border-bottom: 1px solid #d8d8d8;}
          .line input:focus{border-bottom: 1px solid #ffb300;}
          .line input.password{width: calc(100% - 25px); padding-right: 25px;}
          .line input.code{width: calc(100% - 30%);}
          .line button{width: 25%; height: 35px; line-height: 35px; border-radius: 3px; border: 1px solid #ffb300; text-align: center;
          font-size: 14px; color: #ffb300; float: right;}
          .line em{width: 25px; height: 35px; position: absolute;  top: 0; right: 0; background: url(../../image/eye2.png) center no-repeat;
          background-size: 22px 18px;}
          .line em.on{background: url(../../image/eye1.png) center no-repeat; background-size: 22px 16px;}
          .line .lf_name{width: 28%; height: 35px; line-height: 35px; border-radius: 3px; border: 1px solid #ffb300; text-align: center;
          font-size: 14px; color: #ffb300; float: right;}
          .next{width: 100%; height: 43px; line-height: 43px; border-radius: 3px; background: #b1b1b1; text-align: center;
          color: #fff; font-size: 18px; margin-top: 30px;}
          .next.on{background: #ffb300;}

          .bg{width: 185px; height: 157px; background: url(../../image/login_bg.png) no-repeat center; background-size: 185px 157px;
          position: absolute; bottom: 0; right: 0;}
          .bg.on{background: url(../../image/login_bg1.png) no-repeat center; background-size: 185px 157px;}
      </style>
  </head>
  <body>
      <div class="content">
          <header>
              <em tapmode onclick="go_back()"></em>
              找回密码
          </header>

          <div class="line">
              <input class="tel" type="number" placeholder="请输入您的手机号码" oninput="checkValue()" onpropertychange="checkValue()">
          </div>
          <div class="line">
              <input class="code" type="number" placeholder="请输入验证码" oninput="checkValue()" onpropertychange="checkValue()">
              <input type="button" class="lf_name" value="获取验证码" tapmode onclick="getCode(this)">
          </div>
          <div class="line">
              <input class="tel" id="password1" type="password" placeholder="请输入密码" oninput="checkValue()" onpropertychange="checkValue()">
          </div>
          <div class="line">
              <input class="tel" id="password2" type="password" placeholder="请确认密码" oninput="checkValue()" onpropertychange="checkValue()">
              <em class="on" tapmode onclick="change(this)"></em>
          </div>
          <button class="next" disabled="disabled" tapmode onclick="checkRole()">确定</button>

      </div>

  </body>
  <script type="text/javascript" src="../../script/api.js"></script>
  <script type="text/javascript" src="../../script/my.js"></script>
  <script type="text/javascript">
      var token;
      var header = $api.dom('header');
  		fixStatusBar_API(header);
      apiready = function(){
          loading();
          token = $api.getStorage('token');
      };

      //实时监测输入框输入事件
      function checkValue(){
          var tel = $api.val($api.dom('.tel'));
          var code = $api.val($api.dom('.code'));
          var password1 = $api.val($api.dom('#password1'));
          var password2 = $api.val($api.dom('#password2'));
          if (tel && code && password1 && password2) {
              $api.addCls($api.dom('.next'), 'on');
              $api.removeAttr($api.dom('.next'), 'disabled');
          }else {
              $api.removeCls($api.dom('.next'), 'on');
              $api.attr($api.dom('.next'), 'disabled');
          }
      }

      // 获取验证码
      var wait = 60;
      function getCode(obj){
          var myreg = /^1[0-9]{10}$/;//判断是否为手机号码,/^1[34578]\d{9}$/
          var tel = $api.val($api.dom('.tel'));
          if (!myreg.test(tel)) {
              api.toast({
                  msg: '请输入有效的手机号码',
                  duration: 2000,
                  location: 'middle'
              });
              return false;
          }else{
              SendCode(obj,tel,wait);
          }
      };

      // 检查用户身份
      function checkRole(){
          var tel = $api.val($api.dom('.tel'));
          var code = $api.val($api.dom('.code'));
          var password1 = $api.val($api.dom('#password1'));
          var password2 = $api.val($api.dom('#password2'));
          var myreg = /^1[0-9]{10}$/;//判断是否为手机号码,/^1[34578]\d{9}$/
          var mypatrn = /^[0-9A-Za-z]{6,}$/;//密码长度不少于6位,并且由数字和字符组成
          if (!myreg.test(tel)) {
              api.toast({
                  msg: '请输入有效的手机号码',
                  duration: 2000,
                  location: 'middle'
              });
              return false;
          }else if (code == '') {
              api.toast({
                  msg: '请输入验证码',
                  duration: 2000,
                  location: 'middle'
              });
              return false;

          }else if (!mypatrn.test(password1)) {
              api.toast({
                  msg: '请输入至少6位数非中文密码',
                  duration: 2000,
                  location: 'middle'
              });
              return false;
          }else if (password2 !== password1) {
            api.toast({
                msg: '两次密码输入不一致',
                duration: 2000,
                location: 'middle'
            });
            return false;
          }
          api.ajax({
              url: serverurl,
              method: 'get',
              data: {
                  values: {
                      type: '10179',
                       tel:tel
                  },
              }
          },function(ret, err){

              if (ret) {

                  if (ret.length == 2) {
                      selRole(tel,code,password1,password2);
                  }else if (ret.status == '0') {
                      api.toast({
                          msg: '账号未注册',
                          duration: 2000,
                          location: 'middle'
                      });

                  }else {
                      var index = ret[0].role;

                      ChangePwd(index,tel,code,password1,password2);
                  }
              } else {

                  api.toast({
                      msg: '网络错误',
                      duration: 2000,
                      location: 'bottom'
                  });

              }
          });

      }

      // 选择身份弹出层
      function selRole(tel,code,password1,password2){
        var dialogBox = api.require('dialogBox');
          dialogBox.scene({
              rect: {
                  w: 280,
                  h: 150
              },
              texts: {
                  title: '请选择身份',
              },
              styles: {
                  bg: '#fff',
                  corner: 5,
                  title: {
                      bg: '#ffb300',
                      h: 50,
                      size: 20,
                      color: '#fff'
                  },
                  cell: {
                      bg: '#fff',
                      h: 50,
                      text: {
                          color: '#212121',
                          size: 18,
                          align: 'center'
                      },
                  },
              },
              optionDatas: [{
                  text: '学生家长'
              }, {
                  text: '助教'
              }],
              tapClose:true
          }, function(ret, err) {
              if (ret.eventType == 'cell') {

                  dialogBox.close({
                      dialogName: 'scene'
                  });
                  if (ret.index == '0') {
                      var index = 1;
                  }else {
                      var index = 2;
                  }
                  ChangePwd(index,tel,code,password1,password2);
              } else {
                  console.log(JSON.stringify(err));
              }
          });
      }

      // 修改用户密码
      function ChangePwd(index,tel,code,password1,password2){

        $api.css($api.dom('#loading'), 'display:block');
        api.ajax({
            url: serverurl,
            method: 'post',
            data: {
                values: {
                     type: '10009',
                     	tel:tel,
                     code:code,
                      pwd:password1,
                     role:index
                },
            }
        },function(ret, err){
            $api.css($api.dom('#loading'), 'display:none');

            if (ret) {
              if (ret.status == '1') {
                  api.toast({
                      msg: '重置密码成功',
                      duration: 2000,
                      location: 'middle'
                  });

                  go_back();
              }else if (ret.status == '2') {
                api.toast({
                    msg: '验证码不正确',
                    duration: 2000,
                    location: 'middle'
                });
              }else if (ret.status == '0') {
                  api.toast({
                      msg: '账号未注册',
                      duration: 2000,
                      location: 'middle'
                  });
              }else{
                api.toast({
                    msg: '重置密码失败',
                    duration: 2000,
                    location: 'middle'
                });
              }
            } else {
                api.toast({
                    msg: '网络错误',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
      }

      // 切换显示密码
      function change(e){
          if ($api.hasCls(e,'on')) {
              $api.attr($api.dom('#password1'), 'type', 'text');
              $api.attr($api.dom('#password2'), 'type', 'text');
              $api.removeCls(e, 'on');
          }else{
              $api.attr($api.dom('#password1'), 'type', 'password');
              $api.attr($api.dom('#password2'), 'type', 'password');
              $api.addCls(e, 'on');
          }
      }
  </script>
  </html>
