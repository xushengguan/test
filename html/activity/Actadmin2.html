<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>活动管理</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/loading.css">
    <link rel="stylesheet" type="text/css" href="../../icon/iconfonts/iconfont.css">
    <style media="screen">

        .NoAct {

            height:50px;
            padding: 20% 15px;
            text-align: center;
            color: #333;
            font-size: 16px;
        }

        .enter{
        	padding-bottom:60px;
        }
        .enter-header{
        	width: 100%;
        	text-align: center;
        	background: #fcd058;
        }
        .enter-header h5{
        	padding: 15px;
        	font-size: 16px;
        }
        .enter-con{
        	width: 100%;
        }

        .slide-pic1{
        	width:100%;
        	height: 100%;
        	display: block;
        }
        .Lis{
            margin: 10px;
            box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.22);
            border-radius: 4px;
        }

        .enter-news {
            background: white;
            margin-bottom: 1px;
        }
        .news-con{
        	padding:15px;
        	position: relative;
          background: #fff;
          height: 55px;
        }
        .img-pic08{
        	width:55px;
        	height:55px;
        	border-radius: 2px;
        	background:#bbbaba;
          float: left;
          display: block;
        }
        .img-pic08 img{
          display: block;
        	width: 100%;
          height: 100%;
        }
        .content {
        	padding: 0 10px;
        	width: 65%;
          display: block;
          float: left;
        }
        .content h6{
        	color:#212121;
        	font-size: 14px;
        	line-height: 18px;
        }
        .sites{
        	font-size: 12px;
        	color:#cfcfcf;
        	line-height: 18px;
        }
        .peoples{
        	position: absolute;
        	bottom: 13px;
        	right: 11px;
        }

        .actLis{
            position: relative;
        }
        .del {
            width: 80px;
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 3px;
            background: #fff;
            text-align: center;
            color: #333;
            font-size: 16px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, .1);
            z-index: 99;
            display: none;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>

        <div class="box">
            <div class="Lis" v-if="ActInfo.status !== '0'">
                <div class="actLis" v-for="v in ActInfo">
                    <div class="enter-news" tapmode @click="goDatail(v.id)" @touchstart="goDel($event,v.id)" @touchmove="Move" @touchend="touchEnd" v-if="role == '2'">
                        <div class="news-con hide">
                            <span class="fl img-pic08"><img :src="v.actimgurl" alt=""></span>
                            <div class="content fl">
                                <h6 class="single">{{v.title}}</h6>
                                <p class="sites">{{v.address}}</p>
                                <p class="sites">活动时间:{{v.actstarttime | formatDate}}</p>
                            </div>
                            <span class="peoples sites">{{v.userlimit}}人</span>
                        </div>
                    </div>
                    <div class="enter-news" tapmode @click="goDatail(v.id)" @touchstart="goDel($event,v.apply_id)" @touchmove="Move" @touchend="touchEnd" v-else>
                        <div class="news-con hide">
                            <span class="fl img-pic08"><img :src="v.actimgurl" alt=""></span>
                            <div class="content fl">
                                <h6 class="single">{{v.title}}</h6>
                                <p class="sites">{{v.address}}</p>
                                <p class="sites">活动时间:{{v.actstarttime | formatDate}}</p>
                            </div>
                            <span class="peoples sites">{{v.userlimit}}人</span>
                        </div>
                    </div>
                    <div class="del">删除</div>
                </div>
            </div>
            <div class="NoAct" v-else>抱歉，您暂时还没有结束的活动！</div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/my.js"></script>
<script type="text/javascript" src="../../script/vue.js"></script>
<script type="text/javascript" src="../../script/date.js"></script>
<script type="text/javascript">
var id, token;
var timeOutEvent = 0;
apiready = function() {
    loading();
    id = $api.getStorage('id');
    token = $api.getStorage('token');
    vm.get_ActLis();
    //刷新
    api.setRefreshHeaderInfo({
        loadingImg: 'widget://image/refresh.png',
        bgColor: '#444',
        textColor: '#fff',
        textUp: '释放立即刷新...',
        textLoading: '加载中···',
        showTime: true
    }, function(ret, err) {
        //在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
        window.location.reload();
        api.refreshHeaderLoadDone();
    });
};
var vm = new Vue({
    el: '#app',
    data: {
        ActInfo: [],
        role:''
    },
    filters: {
        formatDate(time) {
            var date = new Date(time * 1000);
            return formatDate(date, 'yyyy-MM-dd');
        }
    },
    methods: {
        get_ActLis() { //获取活动列表（支教老师）

            $api.css($api.dom('#loading'), 'display:block');
            var role = $api.getStorage('role');
            if (role == '2') {
                var type = '10151';//获取活动列表（支教老师）
            }else {
                var type = '10028';//获取用户报名活动列表（学生）
            }
            vm.role = role;
            api.ajax({
                url: serverurl,
                method: 'get',
                dataType: 'json',
                data: {
                    values: {
                        type: type,
                        uid: id,
                        token: token,
                        status: '0' //活动状态.0已结束，1活动进行中，2活动未开始
                    }
                }
            }, function(ret, err) {
                $api.css($api.dom('#loading'), 'display:none');

                if (ret) {
                    vm.ActInfo = ret;
                }else if (ret.status == '5') {
                    ExitLogin();
                }else {
                    api.toast({
                        msg: '网络错误',
                        duration: 2000,
                        location: 'bottom'
                    });

                }


            });
        },

        goDatail(actid) { //跳到活动详情

            api.openWin({
                name: 'ActDetail',
                url: './ActDetail.html',
                pageParam: {
                    actid: actid,
                }
            });
        },

        // 长按删除活动
        goDel(e,actid){
            var Del = $api.next(e.currentTarget);
            timeOutEvent = setTimeout(function(e){
                $api.css(Del, 'display:block');
            },500);

            Del.onclick = function(e){

                api.confirm({
                    title: '删除活动',
                    msg: '您确定删除此活动？',
                    buttons: ['确定', '取消']
                }, function(ret, err){
                    if( ret ){

                         if(ret.buttonIndex == 1){
                            if (vm.role == '2') {
                                vm.Delact(actid);
                            }else {
                                vm.stuDelAct(actid);
                            }

                         }
                    }else{
                         console.log( JSON.stringify( err ) );
                    }
                });

            };
            document.onclick = function(e){
                $api.css(Del, 'display:none');
                e.stopPropagation();//阻止事件冒泡
            };

        },
        Move(){
            clearTimeout(timeOutEvent);
        },
        touchEnd(){
            clearTimeout(timeOutEvent);
            return false;
        },

        Delact(actid){//支教老师删除活动
            api.ajax({
                url: serverurl,
                method: 'get',
                data: {
                    values: {
                        type: '10154',
                        token:token,
                        id:actid
                    },
                }
            },function(ret, err){
                if (ret) {

                    if (ret.status == '5') {
                        ExitLogin();
                    }else if (ret.status == '1') {
                        api.toast({
                            msg: '删除成功',
                            duration: 2000,
                            location: 'middle'
                        });
                        vm.get_ActLis();
                    }else {
                        api.toast({
                            msg: '删除失败',
                            duration: 2000,
                            location: 'middle'
                        });
                    }
                } else {

                    api.toast({
                        msg: '网络错误',
                        duration: 2000,
                        location: 'bottom'
                    });

                }
            });

        },

        stuDelAct(apply_id){//学生家长用户删除自己已经报名的活动
          api.ajax({
              url: serverurl,
              method: 'get',
              data: {
                  values: {
                      type: '10027',
                      token:token,
                      apply_id:apply_id
                  },
              }
          },function(ret, err){
              if (ret) {

                  if (ret.status == '5') {
                      ExitLogin();
                  }else if (ret.status == '1') {
                      api.toast({
                          msg: '删除成功',
                          duration: 2000,
                          location: 'middle'
                      });

                      vm.get_ActLis();
                  }else {
                      api.toast({
                          msg: '删除失败',
                          duration: 2000,
                          location: 'middle'
                      });
                  }
              } else {

                  api.toast({
                      msg: '网络错误',
                      duration: 2000,
                      location: 'bottom'
                  });

              }
          });
        }

    }
})
</script>

</html>
