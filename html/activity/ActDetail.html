<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>活动详情</title>
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<link rel="stylesheet" href="../../css/api.css">
	<link rel="stylesheet" href="../../css/loading.css">
	<link rel="stylesheet" href="../../css/swiper.min.css">
	<link rel="stylesheet" href="../../icon/iconfonts/iconfont.css">
	<style media="screen">
	      body{
	      		background: #fff;
	      }
				header {
						height: 50px;
						line-height: 50px;
						background: #ffb300;
						color: #fff;
						font-size: 18px;
						position: relative;
				}

				header em {
						width: 50px;
						height: 50px;
						background: url(../../image/back.png) no-repeat center;
						background-size: 20px;
						float: left;
				}

			.swiper{width: 100%; position: relative;}
			.swiper img{display: block; width: 100%; height: 200px;}
			.swiper em{width: 20px; height: 20px; background: url(../../image/back.png) no-repeat top;
				background-size: cover; position: absolute; top: 35px; left: 15px;}

			.main{padding-top: 15px; background: #f2f2f2;}
			.userInfo{overflow: hidden; padding: 15px 15px 0;}
			.userInfo img{float: left; width: 63px; height: 63px;}
			.userInfo .msg{margin-left: 12px; float: left; width: calc(100% - 75px)}
			.userInfo .msg .title{color: #000; font-size: 18px; font-weight: bold;}
			.userInfo .msg .userId{color: #666; font-size: 15px;}

			.SignUp{padding: 15px; overflow: hidden; text-align: right;}
			.SignUp button{width: 90px; height: 32px; line-height: 32px; border-radius: 3px; color: #fff;
				text-align: center; font-size: 14px; background: #09bb07;}
			.SignUp button.on{background: #e85324;}
			.SignUp button.on1{background: #3e53f2;}
			.SignUp .places{color: #666; font-size: 12px; margin-top: 5px;}

			.Actinfo{padding: 25px 15px; }
			.Actinfo .timeAndtel{width: 100%; overflow: hidden;}
			.Actinfo .timeAndtel .half{width: calc(50% - 35px); height: 32px; background: url(../../image/time.png) no-repeat left center;
				 background-size: 25px; padding-left: 35px; float: left;}
			.Actinfo .timeAndtel .half.tel{background: url(../../image/tel.png) no-repeat left center; background-size: 25px;
			margin-left: 15px; width: calc(50% - 50px)}
			.timeAndtel .half .time{line-height: 18px; color: #333; font-size: 15px;}
			.timeAndtel .half .points{line-height: 14px; color: #666; font-size: 14px;}
			.Actinfo .timeAndtel .address{padding-top: 30px; width: 100%; display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;
			 -webkit-box-align:center;-webkit-align-items:center;-ms-flex-align:center;align-items:center;}
			.address em{width: 22px; height:29px; background: url(../../image/map.png) no-repeat left center;
				 background-size: 22px 29px; margin-right: 10px;}

			.content{background: #fff; padding: 15px 15px 65px 15px; font-size: 16px; color: #999; line-height: 20px;
				word-wrap: break-word; word-break: normal;}

			.ActStaus{height: 40px; line-height: 40px; font-size: 15px; color: #fff; padding-left: 18px; background: #ffb300;
			position: relative; margin-top: 10px;}
			.ActStaus.on{background: #09bb07;}
			.ActStaus em{width: 50px; height: 40px; background: url(../../image/more.png) center no-repeat; background-size: 14px;
			position: absolute; top: 0; right: 0; display: block;}

			footer{height:50px; width: 100%; overflow: hidden; box-shadow: 0px -3px 7px 0px rgba(0, 0, 0, 0.2); position: fixed; bottom: 0;
				background-color: #ffb300; line-height: 50px; font-size: 16px; color: #fff; display:-webkit-box;
				display:-webkit-flex;display:-ms-flexbox;display:flex; -webkit-box-pack:center;-webkit-justify-content:center;
				-ms-flex-pack:center;justify-content:center;}
      footer em{width: 16px; height: 50px; background: url(../../image/scan.png) no-repeat left center;
			background-size: 16px; padding-left: 5px;}

			.img{height: calc(100% - 60px); padding:15px 6px 15px 6px; overflow: hidden; background: #fff;}
			.img .title{padding:5px 6px 10px 6px; font-size: 15px; color: #292929; font-weight: bold;}
			.img .prompt{font-size: 13px; color: #aaa; padding: 0 6px 15px 6px;}
			.img .item{width: calc(33.33% - 12px); position: relative; float: left; margin: 0 6px;}
			.img .item:before{content: ''; display: inline-block; padding-bottom: 100%; width: 0.1px; vertical-align: middle;}
			.img .item img{position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block;}

      /*swiper begin*/
			.swiper-container {width: 100%;  box-shadow: 0 1px 2px rgba(0,0,0,.1); padding:15px 0;}
	    .swiper-slide {text-align: center;font-size: 18px;}
			.swiper-slide .pic{height: 65px; position: relative;}
			.swiper-slide .pic em{width: 19px; height: 22px; background: url() no-repeat center; background-size: contain; position: absolute;
			bottom: 0px; left: 50%; transform: translateX(50%); display: none;}
			.swiper-slide:nth-child(1) .pic em{display: block; background: url(../../image/1st.png) no-repeat center; background-size: contain;}
			.swiper-slide:nth-child(2) .pic em{display: block; background: url(../../image/2st.png) no-repeat center; background-size: contain;}
			.swiper-slide:nth-child(3) .pic em{display: block; background: url(../../image/3st.png) no-repeat center; background-size: contain;}
	    .swiper-slide .pic img{width: 63px; height: 63px;  border-radius: 50%; border:2px solid #fff;}
	    .swiper-slide .name{font-size: 14px; color: #212121; display: block; padding-top: 8px;}
	</style>
</head>

<body>
	  <div id="wrap" v-cloak>
				<header>
						<em tapmode onclick="go_back()"></em> 活动详情
				</header>
			  <div id="main">
					<div class="swiper" v-if="data.actimgurl">
							<img :src="data.actimgurl" alt="">
					</div>
					<div class="main">
							<div class="userInfo">
									<img :src="data.headimgurl" alt="" v-if="data.headimgurl">
									<img src="../../image/pic3.png" alt="" v-else>
									<div class="msg">
											<div class="title">{{data.title}}</div>
											<div class="userId">活动ID:{{data.id}}</div>
											<div class="userId" v-if="data.join_num">报名人数:{{data.join_num}}</div>
									</div>
							</div>

							<div class="SignUp">
								  <!-- 加class on 进行中为状态，on1则为已结束状态,否则为等待开始状态-->
									<button tapmode onclick="changeState(1)" v-show="data.actsta == 2 && role == '2'">开始活动</button>
									<button tapmode onclick="changeState(0)" class="on" v-show="data.actsta == 1 && role == '2'">结束活动</button>
									<button class="on1" v-show="data.actsta == 0">已结束</button>
									<button tapmode onclick="joinAct()" v-show="status == '0' && data.actsta == 2 ">报名参加</button>
									<button class="on" v-show="status == '1' && role == '1' && data.actsta != 0">已报名</button>
									<!-- <div class="places">剩余名额:20人</div> -->
							</div>

							<!-- 活动状态 -->
							<div class="ActStaus" tapmode v-if="data.actsta == 1 || data.actsta == 0 && role == '2'" @click="goMarkPage(data.id)">
								查看打分记录
								<em></em>
							</div>

							<!-- Swiper -->
						  <div class="swiper-container" v-if="!rank.status">
						    <div class="swiper-wrapper">
						      <div class="swiper-slide" v-for="v in rank">
										  <div class="pic">
												  <em></em>
										  		<img :src="v.stu_img" alt="" v-if="v.stu_img">
													<img src="../../image/pic3.png" alt="" v-else>
										  </div>
											<span class="name">{{v.stu_name}}</span>
						      </div>
						    </div>
						  </div>
			        <!-- Swiper 活动结束排名-->

							<!-- actsta='1' 进行中，actsta='0' 结束 -->
							<div class="img" v-show="data.actsta == '1' && role == '2'">
								  <div class="title">上传活动照片</div>
									<div class="prompt">注意：请至少上传3张活动照片，照片中需要包含有参赛者</div>
									<div class="item" tapmode onclick="UploadPic(this,'start_img')">
	                    <img :src="data.start_img+'?x-oss-process=image/resize,p_50'" alt="" v-if="data.start_img">
											<img id="img1" src="../../image/up1.png" alt="" v-else>
									</div>
									<div class="item" tapmode onclick="UploadPic(this,'underway_img')">
	                    <img :src="data.underway_img+'?x-oss-process=image/resize,p_50'" alt="" v-if="data.underway_img">
											<img id="img2" src="../../image/up2.png" alt="" v-else>
									</div>
									<div class="item" tapmode onclick="UploadPic(this,'end_img')">
	                    <img :src="data.end_img+'?x-oss-process=image/resize,p_50'" alt="" v-if="data.end_img">
											<img id="img3" src="../../image/up3.png" alt="" v-else>
									</div>
							</div>

							<div class="img" v-show="data.actsta == '0' && data.start_img || data.underway_img || data.end_img">
									<div class="item">
	                    <img :src="data.start_img+'?x-oss-process=image/resize,p_50'" alt=""  @click="viewPicture(data.start_img)" v-if="data.start_img">
									</div>
									<div class="item">
	                    <img :src="data.underway_img+'?x-oss-process=image/resize,p_50'" alt=""  @click="viewPicture(data.underway_img)" v-if="data.underway_img">
									</div>
									<div class="item">
	                    <img :src="data.end_img+'?x-oss-process=image/resize,p_50'" alt=""  @click="viewPicture(data.end_img)" v-if="data.end_img">
									</div>
							</div>

							<div class="Actinfo">
									<div class="timeAndtel">
											<div class="half">
													<p class="tiem">{{data.actstarttime | formatDate}}</p>
													<p class="points">{{data.actstarttime | formatDate1}}开始</p>
											</div>
											<div class="half tel">
													<p class="tiem" @click="goCall(data.tel)">{{data.tel}}</p>
													<p class="points">{{data.nickname}}</p>
											</div>
											<div class="address"><em></em>{{data.address}}</div>
									</div>
							</div>
					</div>

					<div class="content" v-show="data.content">
							{{data.content}}
					</div>
				</div>
				<footer v-show="data.actsta == 1 && role == '2'" tapmode onclick="scan()">
					    <em></em>点击扫码 为他打分
				</footer>
		</div>


</body>
</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/my.js"></script>
<script type="text/javascript" src="../../script/swiper.min.js"></script>
<script type="text/javascript" src="../../script/vue.js"></script>
<script type="text/javascript" src="../../script/date.js"></script>
<script type="text/javascript">

		var header = $api.dom('header');
		fixStatusBar_API(header);

		var actid,token,role,uid;
		apiready = function(){
        fnInitSwipe();
			  loading();

			  actid = api.pageParam.actid;
        token = $api.getStorage('token');
				uid = $api.getStorage('id');
				role = $api.getStorage('role');//角色代号 1：学生家长，2：班主任

				if (role !== '2') {
						vm.checkSignUp();
				}
				vm.getDetail();


		}

		var vm = new Vue({
				el:'#wrap',
				data:{
						data:[],
						role:'',
						status:'',
						rank:[]
				},
				filters: {
            formatDate(time) {
                var date = new Date(time * 1000);
                return formatDate(date, 'yyyy-MM-dd');
            },
						formatDate1(time){
								var date = new Date(time * 1000);
								return formatDate(date, 'hh:mm:ss');
						}
        },
				methods:{
						getDetail(){//获取活动详情
                vm.role = role;

                $api.css($api.byId('loading'), 'display:block');
								$api.css($api.byId('main'), 'display:none');
								api.ajax({
								    url: serverurl,
								    method: 'get',
										cache:true,
								    data: {
								        values: {
								             type: '10018',
														  id: actid,
														token:token
								        },
								    }
								},function(ret, err){
									  $api.css($api.byId('loading'), 'display:none');
                    $api.css($api.byId('main'), 'display:block');

								    if (ret) {
                        if (ret.status == '5') {
														ExitLogin();
                        }
												vm.data = ret;

											  if (ret.actsta == 0) {//活动状态 0 已结束 1 活动进行中 2活动未开始
														vm.getRank();
											  }

								    }else {

												api.toast({
												    msg: '网络错误',
												    duration: 2000,
												    location: 'bottom'
												});

								    }
								});
						},

						checkSignUp(){//查询用户是否报名
								api.ajax({
								    url: serverurl,
								    method: 'get',
								    data: {
								        values: {
								             type: '10177',
														 uid:uid,
														actid:actid,
														token:token
								        },
								    }
								},function(ret, err){

								    if (ret) {
                        if (ret.status == '5') {
                        		ExitLogin();
                        }
												vm.status = ret.status;
								    }else {

												api.toast({
												    msg: '网络错误',
												    duration: 2000,
												    location: 'bottom'
												});

								    }
								});
						},

						getRank(){//活动结束时显示排名

								api.ajax({
								    url: serverurl,
								    method: 'get',
								    data: {
								        values: {
								             type: '10156',
														token: token,
														actid:actid
								        },
								    }
								},function(ret, err){

								    if (ret) {

											if (ret.status == '5') {
													ExitLogin();
											}
											vm.rank = ret;

								    }else {

												api.toast({
												    msg: '网络错误',
												    duration: 2000,
												    location: 'bottom'
												});

								    }
								});
						},

						goCall(tel){
								api.call({
								    type: 'tel_prompt',
								    number: tel
								});
						},

						viewPicture(data){
								var url = [];
								url.push(data);
								var imageBrowser = api.require('imageBrowser');
								imageBrowser.openImages({
										imageUrls: url
								});
            },

						goMarkPage(actid){
								api.openWin({
								    name: 'markPage_title',
								    url: './markPage_title.html',
								    pageParam: {
								        actid: actid
								    },
										reload:true
								});

						}

				},


		})

		// swiper
		function fnInitSwipe(){
			var swiper = new Swiper('.swiper-container', {
				slidesPerView: 5,
				spaceBetween: 9,
				freeMode: true,
				centeredSlides: true,
				observer:true, //修改swiper自己或子元素时，自动初始化swiper
    		observeParents:true,//修改swiper的父元素时，自动初始化swiper

			});
		}

		// 上传活动照片
    function UploadPic(e,num){
				getPicture('album',function(ret){
						if (ret.data) {
							 uploader(e,num,ret.data);
						}
				})
		}

		//获取图片
		function getPicture(type,callback){
      api.getPicture({
        sourceType: type,
        encodingType: 'jpg',
        mediaValue: 'pic',
        destinationType: 'url',
        allowEdit: true,
        quality: 100,
        saveToPhotoAlbum: false
      }, function(ret, err) {

        if (ret.data) {
            callback(ret);
        }
      });
    }

		//获取阿里云签名
  	function uploader(e,num,src) {
  		$api.css($api.dom('#loading'), 'display:block');
  		api.ajax({
  			url: serverurl,
  			method: 'post',
  			data: {
  				values: {
  					type: '10033',
  				},

  			}
  		}, function(ret, err) {

  			if (ret) {
  				var host = ret.host;
  				var policy = ret.policy;
  				var signature = ret.signature;
  				var accessid = ret.accessid;
  				var dir = ret.dir;
  				var expire = ret.expire;

          ALIcloud(e,num,src,host, policy, signature, accessid, dir, expire);
  			} else {

  				api.toast({
  					msg: '网络错误',
  					duration: 2000,
  					location: 'middle'
  				});

  			}
  		});
  	}

		//将图片上传给阿里云服务器
  	function ALIcloud(e,num,src,host, policy, signature, accessid, dir, expire) {

      		api.ajax({
      			url: host,
      			method: 'post',
      			dataType: 'xml',
      			data: {
      				values: {
      					OSSAccessKeyId: accessid,
      					policy: policy,
      					Signature: signature,
      					key: dir,
      					success_action_status: 201
      				},
      				files: {
      					file: src
      				}
      			}
      		}, function(ret, err) {

      			if (ret) {
      				// 在回调函数里面调用
      				var dom = parseXML(ret);
      				// location 标签的内容使用DOM选择器进行查找
      				var url = dom.querySelector('Location').innerHTML;
 							if (url) {
 									postPic(e,num,url);
 							}
      			} else {
      				api.toast({
      					msg: '网络错误',
      					duration: 2000,
      					location: 'middle'
      				});
      			}
      		});
  	}

    // 提交活动照片
		function postPic(e,num,url){

				api.ajax({
				    url: serverurl,
				    method: 'get',
				    data: {
				        values: {
				             type: '10159',
										actid:actid,
										 img:url,
								img_type:num,
									 token:token
				        },
				    }
				},function(ret, err){
					  $api.css($api.dom('#loading'), 'display:none');
				    if (ret) {

								if (ret.status == '5') {
									  ExitLogin();

								}else if (ret.status == '1') {
										$api.attr($api.first(e), 'src', url);
								}else {
										api.toast({
										    msg: '上传失败',
										    duration: 2000,
										    location: 'bottom'
										});

								}
				    }else {

								api.toast({
								    msg: '网络错误',
								    duration: 2000,
								    location: 'bottom'
								});

				    }
				});

		}

		// 改变活动状态
		function changeState(num){
			    if (num == 0) {
						api.confirm({
							title: '确认结束活动',
							msg: '请您确认上传3张活动图片并为每个参赛者打分后再结束活动,否则将无法获得奖金',
							buttons: ['确认结束', '再等等']
						}, function(ret, err) {
							var index = ret.buttonIndex;

							if (index == 1) {
									chageAct(num);
							}
						});
			    }else {
							chageAct(num);
			    }
    }

		function chageAct(num){//改变活动状态
			api.ajax({
					url: serverurl,
					method: 'get',
					data: {
							values: {
									type: '10150',
								 token: token,
										id:actid,
								actsta:num
							},
					}
			},function(ret, err){
					if (ret) {
              if (ret.status == '5') {
									ExitLogin();
              }else if (ret.status == '1') {
									api.toast({
											msg: '操作成功',
											duration: 2000,
											location: 'bottom'
									});
									if (num == 0) {
											index = 0;
									}else if (num == 1) {
											index = 1;
									}
									vm.getDetail();
							}else {
									api.toast({
											msg: '操作失败',
											duration: 2000,
											location: 'bottom'
									});

							}
					} else {

							api.toast({
									msg: '网络错误',
									duration: 2000,
									location: 'bottom'
							});

					}
			});
		}
		 // 扫描二维码
		function scan(){
			var FNScanner = api.require('FNScanner');
			FNScanner.openScanner({
					autorotation: true
			}, function(ret, err) {
					if (ret) {
							if (ret.eventType == 'success') {

                  if (ret.content.indexOf("123win.com.cn/s/") >= 0) {

											api.openWin({
											    name: 'mark',
											    url: '../setting/mark.html',
											    pageParam: {
											        actid: vm.data.id,
															key:ret.content
											    },
													reload:true
											});

                  }else {
                  		api.toast({
                  		    msg: '二维码不正确',
                  		    duration: 2000,
                  		    location: 'middle'
                  		});

                  }

							}else if (ret.eventType == 'fail') {
									api.toast({
											msg: '扫描失败',
											duration: 2000,
											location: 'middle'
									});

							}
					} else {
							api.toast({
									msg: err,
									duration: 2000,
									location: 'bottom'
							});
					}
			});
		}

		// 学生报名参加活动
		function joinAct(){

			api.ajax({
					url: serverurl,
					method: 'get',
					data: {
							values: {
									type: '10016',
								 token: token,
								actid:actid,
								 uid:uid
							},
					}
			},function(ret, err){

					if (ret) {
						  if (ret.status == '5') {
									ExitLogin();
						  }else if (ret.status == '1') {
									api.toast({
											msg: '报名成功',
											duration: 2000,
											location: 'middle'
									});
									vm.checkSignUp();
									vm.getDetail();
							}else if (ret.status == '3') {
								   api.toast({
								       msg: '抱歉，此活动您已报名',
								       duration: 2000,
								       location: 'middle'
								   });

							}else {
									api.toast({
											msg: '操作失败',
											duration: 2000,
											location: 'middle'
									});

							}
					} else {

							api.toast({
									msg: '网络错误',
									duration: 2000,
									location: 'bottom'
							});

					}
			});

		}
</script>
