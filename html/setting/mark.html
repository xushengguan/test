<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
      <title>打分</title>
      <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
      <link rel="stylesheet" type="text/css" href="../../css/loading.css"/>
      <style>
      header {
          height: 50px;
          line-height: 50px;
          background: #ffb300;
          color: #fff;
          font-size: 20px;
          position: relative;
          box-shadow: 0px 2px 6px 0px rgba(0, 0, 0, 0.25);
      }

      header em {
          width: 50px;
          height: 50px;
          background: url(../../image/back.png) no-repeat center;
          background-size: 18px;
          float: left;
      }

      header span{
          font-size: 18px;
          color: #fff;
          float: right;
          margin-right: 18px;
      }

      .box{padding: 46px 15px 15px 15px;}
      .box .bg{width: 100%; height: 103px; background-image: url(../../image/bracelet.png); background-repeat: no-repeat;
        background-position: center; background-size: contain; position: relative;}
      .box .bg2{width: 205px; height: 103px; position: absolute; left: 50%; transform: translateX(-50%); -webkit-transform: translateX(-50%);
        background: #e0dcdc; opacity: 0.8; border-radius: 3px; box-shadow: 0px 4px 10px 0px rgba(0, 0, 0, 0.15);}
      .box .bg3{background: #fff; margin: 5px; padding: 10px 5px; width: calc(100% - 20px); height: calc(100% - 30px); border-radius: 3px;
      opacity: 0.8;}
      .box .bg3 .input{width: 100%; height: calc(100% - 1px); border-bottom: 1px solid #e0dcdc; text-align: center; font-size: 50px;
      color: #3b3c3c; overflow-x: auto;}
      .bg3 .input em{font-size: 20px; color: #c0bfbf;}
      .total{font-size: 15px; color: #7d7d7d; text-align: center; padding: 23px;}

      .markBox{background: #fff;}
      .markBox .top{padding: 13px 15px; display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;
      -webkit-box-align:center;-webkit-align-items:center;-ms-flex-align:center;align-items:center;}
      .markBox .top img{width: 50px; height: 50px; border-radius: 50%;}
      .info{width: calc(100% - 80px - 24%); padding: 0 15px;}
      .info .name{font-size: 15px; color: #212121; line-height: 25px;}
      .info .remark,.rt .times{font-size: 13px; color: #aaa; line-height: 25px;}
      .rt{width: 24%; text-align: right;}
      .rt .btn{font-size: 13px; color: #ffb300; line-height: 25px;}

      .flexed{ border-top: 1px solid #e8e8e8; width: 100%; overflow: hidden;}
      .flexed .spuared{width: 79%; float: left; overflow: hidden;}
      .flexed .rightBtn{width: 21%; float: left;}
      .spuared li{width: calc(33.33% - 1px); height: 59px; border-right: 1px solid #e8e8e8; border-bottom: 1px solid #e8e8e8;
      font-size: 30px; color: #212121; text-align: center; line-height: 59px; float: left;}
      .spuared li:active{background: #ecedef;}
      .spuared li:last-child{width: calc(100% - 1px); border-bottom: none; height: 60px;}
      .rightBtn .del{width: 100%; height: 98px; background: url(../../image/del.png) no-repeat center; background-size: 37px 27px;}
      .rightBtn .confirm{padding:10px; height: calc(240px - 118px); background: #ffb300; text-align: center; color: #fee9b6; font-size: 15px;
      line-height: 20px;}
      .confirm p{font-size: 22px; color: #fff; line-height: 52px;}

      .popup{width: 100%; height: 100%; background: rgba(0,0,0,.6); position: absolute; top: 0; left: 0;}
      .popup .infoBox{background: #fff; border-radius: 5px; margin: 10px; width: calc(100% - 20px); position: absolute;
        top: 50%; transform: translateY(-50%); -webkit-transform: translateY(-50%);}
      .msg{ overflow: hidden; padding: 10px 15px 7px 15px;}
      .msg img{width: 122px; height: 122px; border-radius: 2px;}
      .msg .rtmsg{padding-left: 20px; width: calc(100% - 142px); float: right;}
      .rtmsg .prompt{font-size: 15px; color: #d2d2d2; padding-bottom: 30px;}
      .rtmsg .name{font-size: 15px; color: #999;}
      .rtmsg input{width: 100%; height: 35px; line-height: 35px; border-bottom: 1px solid #e8e8e8; font-size: 17px; color: #212121;}
      .infoBox textarea{border-radius: 2px; background: #f4f4f4; padding: 10px; font-size: 14px; color: #999; width: calc(100% - 50px);
      margin:7px 15px; height: 38px; resize: none;}
      .infoBox .line{height: 12px; position: relative;}
      .line em{width: 6px; height: 12px; position: absolute; background: rgba(0,0,0,.6);}
      .line em:first-child{border-radius: 0 12px 12px 0; left: 0;}
      .line em:last-child{border-radius: 12px 0 0 12px;  right: 0;}
      .infoBox button{width: 90px; height: 34px; line-height: 34px; border-radius: 2px; background-color: #c0c0c0; float: right; margin-right: 15px;
      font-size: 17px; color: #fff; margin-bottom: 10px;}
      .infoBox .Sumbit.on{background: #ffb300;}
      </style>
  </head>
  <body>
    <div id="wrap">
        <header>
            <em tapmode onclick="go_back()"></em>
            为他打分
            <span tapmode onclick="confirmMark(1)">确认并退出</span>
        </header>
        <div id="main">
            <div class="box">
                <div class="bg">
                    <div class="bg2">
                        <div class="bg3">
                          <div class="input">
                              <span id="result"></span>
                              <em class="txt" style="display:none">分</em>
                          </div>
                        </div>
                    </div>
                </div>
                <p class="total">温馨提示:一次最高可打<em>100</em>分，用户学分上限为750分，24小时内不允许超过100分</p>
            </div>
        </div>
        <div class="markBox">
            <div class="top">
                <img src="../../image/pic3.png" alt="" id="img2">
                <div class="info">
                    <p class="name"></p>
                    <p class="remark"></p>
                </div>
                <div class="rt">
                    <p class="btn" tapmode onclick="ResetName()">修改备注名</p>
                    <p class="times"></p>
                </div>
            </div>
            <div class="flexed">
                <ul class="spuared">
                    <li tapmode onclick="goScore(this)">1</li>
                    <li tapmode onclick="goScore(this)">2</li>
                    <li tapmode onclick="goScore(this)">3</li>
                    <li tapmode onclick="goScore(this)">4</li>
                    <li tapmode onclick="goScore(this)">5</li>
                    <li tapmode onclick="goScore(this)">6</li>
                    <li tapmode onclick="goScore(this)">7</li>
                    <li tapmode onclick="goScore(this)">8</li>
                    <li tapmode onclick="goScore(this)">9</li>
                    <li tapmode onclick="goScore(this)">0</li>
                </ul>
                <div class="rightBtn">
                    <div class="del" tapmode onclick="Del()"></div>
                    <div class="confirm" tapmode onclick="confirmMark()">
                        <p>确认</p>
                        并继续扫码打分
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 支教老师打分 -->
    <div class="popup" style="display:none">
        <div class="infoBox">
            <div class="msg">
                <img id="img" src="../../image/uploader.png" alt="" tapmode onclick="getPicture()">
                <div class="rtmsg">
                    <p class="prompt">请填写信息后再进行打分</p>
                    <p class="name">姓名</p>
                    <input type="text" id="name" oninput="checkValue()" onpropertychange="checkValue()">
                </div>
            </div>
            <div class="line">
              <em></em>
              <em></em>
            </div>
            <textarea name="name" rows="8" cols="80" placeholder="添加备注" id="log"></textarea>
            <button class="Sumbit" disabled="disabled" tapmode onclick="perfectInfo()">提交信息</button>
        </div>
    </div>
  </body>
  <script type="text/javascript" src="../../script/api.js"></script>
  <script type="text/javascript" src="../../script/my.js"></script>
  <script type="text/javascript">
      var header = $api.dom('header');
      fixStatusBar_API(header);
      var uid,token,key,bracelet_id;
      apiready = function(){
          loading();

          uid = $api.getStorage('id');
          token = $api.getStorage('token');
          key = api.pageParam.key.substr(0,4);//提取字符串前四位

          checkActive();

           $api.dom('.popup').ontouchstart = function(event){
               if(event.target == this){
               	  $api.css($api.dom('.popup'), 'display:none');
               }
           }
      };

      //实时监测输入框输入事件
      function checkValue(){
          var name = $api.val($api.dom('#name'));
          if (name) {
              $api.addCls($api.dom('.Sumbit'), 'on');
              $api.removeAttr($api.dom('.Sumbit'), 'disabled');
          }else {
              $api.removeCls($api.dom('.Sumbit'), 'on');
              $api.attr($api.dom('.Sumbit'), 'disabled');
          }
      }

      // 检测手环是否激活
      function checkActive(){
          api.ajax({
              url: serverurl,
              method: 'get',
              data: {
                  values: {
                      type: '10153',
                      token: token,
                      key:key
                  },
              }
          },function(ret, err){

              if (ret) {
                  if (ret.status == '5') {
                      ExitLogin();
                  }else if (ret.status == '0') {
                      $api.attr($api.dom('#img'), 'src', '../../image/uploader.png');
                      $api.val($api.dom('#name'), '');

                      $api.css($api.dom('.popup'), 'display:block');
                  }else if (ret.status == '3') {
                    api.toast({
                        msg: '手环不存在',
                        duration: 2000,
                        location: 'middle'
                    });
                    setTimeout(function(){
                      go_back();
                    },2000)
                  }else {
                      getBracelet();
                  }
              } else {
                  $api.css($api.dom('.top'), 'display:none');

                  api.toast({
                      msg: '网络错误',
                      duration: 2000,
                      location: 'bottom'
                  });

              }
          });

      }

      // 读取手环信息
      function getBracelet(){
        api.ajax({
            url: serverurl,
            method: 'get',
            data: {
                values: {
                    type: '10149',
                    token: token,
                     key: key
                },
            }
        },function(ret, err){

            if (ret) {
                if (ret.status == '5') {
                    ExitLogin();
                }else {
                    if (ret.data) {
                         $api.attr($api.dom('#img2'), 'src',ret.data.stu_img);
                         $api.text($api.dom('.info .name'),ret.data.stu_name);
                         $api.text($api.dom('.remark'), ret.data.log);
                         $api.text($api.dom('.times'),ret.count + '次');
                         bracelet_id = ret.data.id;
                    }else {
                        $api.css($api.dom('.top'), 'display:none');
                    }
                }
            } else {

                api.toast({
                    msg: '网络错误',
                    duration: 2000,
                    location: 'bottom'
                });

            }
        });
      }

      // 完善手环信息
      function perfectInfo(){
          var stu_img = $api.attr($api.dom('#img'), 'src');
          var stu_name = $api.val($api.dom('#name'));
          var log = $api.val($api.dom('#log'));
          if (stu_img == '../../image/uploader.png') {
              api.toast({
                  msg: '请上传头像',
                  duration: 2000,
                  location: 'middle'
              });
              return false;
          }else if (!stu_name) {
              api.toast({
                  msg: '请填写姓名',
                  duration: 2000,
                  location: 'middle'
              });
              return false;
          }else {
              $api.css($api.byId('loading'), 'display:block');

              api.ajax({
                  url: serverurl,
                  method: 'get',
                  data: {
                      values: {
                          type: '10152',
                          token: token,
                         stu_img: stu_img,
                        stu_name: stu_name,
                           log: log,
                          tid: uid,
                           key: key
                      },
                  }
              },function(ret, err){
                  $api.css($api.byId('loading'), 'display:none');

                  if (ret) {
                      if (ret.status == '5') {
                          ExitLogin();
                      }else if (ret.status == '1') {
                          api.toast({
                              msg: '提交成功',
                              duration: 2000,
                              location: 'middle'
                          });
                          $api.css($api.dom('.popup'), 'display:none');
                          getBracelet();
                      }else if (ret.status == '3') {
                        api.toast({
                            msg: '手环不存在',
                            duration: 2000,
                            location: 'middle'
                        });
                        setTimeout(function(){
                          go_back();
                        },2000)
                      }else{
                        api.toast({
                            msg: '提交失败',
                            duration: 2000,
                            location: 'middle'
                        });
                      }

                  } else {

                      api.toast({
                          msg: '网络错误',
                          duration: 2000,
                          location: 'bottom'
                      });

                  }
              });
            }
      }

      // 打分
      function goScore(e){
          var result = $api.text($api.dom('#result'));
          var num = $api.text(e);
          if (!result && num == '0') {
              result = '';
          }else {
              result += num;
              $api.css($api.dom('.txt'), 'display:inline-block');
          }
          $api.text($api.dom('#result'), result);

      }

      // 清除
      function Del(){
          $api.text($api.dom('#result'), '');
          $api.css($api.dom('.txt'), 'display:none');
      }



  		//获取图片
  		function getPicture(){
        api.getPicture({
          sourceType: 'album',
          encodingType: 'jpg',
          mediaValue: 'pic',
          destinationType: 'url',
          allowEdit: true,
          quality: 100,
          saveToPhotoAlbum: false
        }, function(ret, err) {

          if (ret.data) {
              uploader(ret.data);
          }
        });
      }

  		//获取阿里云签名
    	function uploader(src) {
    		$api.css($api.dom('#loading'), 'display:block');
    		api.ajax({
    			url: serverurl,
    			method: 'post',
    			data: {
    				values: {
    					type: '10033',
    				},

    			}
    		}, function(ret, err) {

    			if (ret) {
    				var host = ret.host;
    				var policy = ret.policy;
    				var signature = ret.signature;
    				var accessid = ret.accessid;
    				var dir = ret.dir;
    				var expire = ret.expire;

            ALIcloud(src,host, policy, signature, accessid, dir, expire);
    			} else {

    				api.toast({
    					msg: '网络错误',
    					duration: 2000,
    					location: 'middle'
    				});

    			}
    		});
    	}

  		//将图片上传给阿里云服务器
    	function ALIcloud(src,host, policy, signature, accessid, dir, expire) {

        		api.ajax({
        			url: host,
        			method: 'post',
        			dataType: 'text',
        			data: {
        				values: {
        					OSSAccessKeyId: accessid,
        					policy: policy,
        					Signature: signature,
        					key: dir,
        					success_action_status: 201
        				},
        				files: {
        					file: src
        				}
        			}
        		}, function(ret, err) {

        			if (ret) {
        				// 在回调函数里面调用
        				var dom = parseXML(ret);
        				// location 标签的内容使用DOM选择器进行查找
        				var url = dom.querySelector('Location').innerHTML;
                $api.attr($api.dom('#img'), 'src', url);
                $api.css($api.dom('#loading'), 'display:none');
        			} else {
        				api.toast({
        					msg: '网络错误',
        					duration: 2000,
        					location: 'middle'
        				});
        			}
        		});
    	}


      // 支教老师打分
      function confirmMark(index){
          var result = parseInt($api.text($api.dom('#result')));
          var time = Math.round(new Date().getTime()/1000);
          if (!result) {
              api.toast({
                  msg: '请先打分',
                  duration: 2000,
                  location: 'middle'
              });
              return false;
          }else if (result > 100) {
              api.toast({
                  msg: '抱歉，一次不能超过100',
                  duration: 2000,
                  location: 'middle'
              });
              return false;
          }else {
              $api.css($api.dom('#loading'), 'display:block');
              api.ajax({
                  url: serverurl,
                  method: 'get',
                  data: {
                      values: {
                           type: '10142',
                            uid: uid,
                            token:token,
                            key:key,
                          score:result,
                           actid: api.pageParam.actid,
                            time:time
                      },
                  }
              },function(ret, err){

                  $api.css($api.dom('#loading'), 'display:none');

                  if (ret) {
                      if (ret.status == '5') {
                          ExitLogin();
                      }else if (ret.status == '1') {
                          api.toast({
                              msg: '打分成功',
                              duration: 2000,
                              location: 'bottom'
                          });

                          if (index) {
                              setTimeout(function(){
                                go_back();
                              },800)
                          }else{
                              $api.text($api.dom('#result'),'');
                              scan();
                          }

                      }else if (ret.status == '3') {
                          api.toast({
                              msg: '超出用户学分上限750',
                              duration: 2000,
                              location: 'middle'
                          });

                      }else if (ret.status == '4') {
                          api.toast({
                              msg: '一场活动一天只能打100分',
                              duration: 2000,
                              location: 'middle'
                          });
                      }else{
                          api.toast({
                              msg: '打分失败',
                              duration: 2000,
                              location: 'middle'
                          });

                    }
                  } else {

                      api.toast({
                          msg: '网络错误',
                          duration: 2000,
                          location: 'bottom'
                      });

                  }
              });
          }
      }

      // 扫描二维码
     function scan(){
       var FNScanner = api.require('FNScanner');
       FNScanner.openScanner({
           autorotation: true
       }, function(ret, err) {
           if (ret) {
               if (ret.eventType == 'success') {

                   if (ret.content.indexOf("123win.com.cn/s/") >= 0) {
                        key = ret.content.substr(-4);
                        checkActive();
                   }else {
                       api.toast({
                           msg: '二维码不正确',
                           duration: 2000,
                           location: 'middle'
                       });

                   }

               }else if (ret.eventType == 'fail') {
                   api.toast({
                       msg: '扫描失败',
                       duration: 2000,
                       location: 'middle'
                   });

               }
           } else {
               api.toast({
                   msg: err,
                   duration: 2000,
                   location: 'bottom'
               });
           }
       });
     }

    //  修改备注名
    function ResetName(){
        var name = $api.text($api.dom('.info .name'));
        api.prompt({
            title:'修改备注名',
            text:name,
            buttons: ['确定', '取消']
        }, function(ret, err){
            if( ret ){

                 if (ret.buttonIndex == 1) {
                    resetInfo(ret.text);
                 }
            }else{
                 console.log( JSON.stringify( err ) );
            }
        });
    }
      //  修改手环信息
    function resetInfo(name){

      api.ajax({
          url: serverurl,
          method: 'get',
          data: {
              values: {
                  type: '10148',
                  token: token,
                stu_name:name,
                    id:bracelet_id,
              },
          }
      },function(ret, err){
          if (ret) {
              if (ret.status == '5') {
                  ExitLogin();
              }else if (ret.status == '1') {
                  api.toast({
                      msg: '修改成功',
                      duration: 2000,
                      location: 'middle'
                  });
                  $api.text($api.dom('.info .name'),name);
              }else{
                api.toast({
                    msg: '修改失败',
                    duration: 2000,
                    location: 'middle'
                });
              }
          } else {

              api.toast({
                  msg: '网络错误',
                  duration: 2000,
                  location: 'bottom'
              });

          }
      });
    }
  </script>
  </html>
