<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>账户设置</title>
	<link rel="stylesheet" href="../../css/api.css">
	<link rel="stylesheet" href="../../css/common.css">
	<link rel="stylesheet" href="../../icon/iconfonts/iconfont.css">
	<link rel="stylesheet" href="../../css/7account.css">
	<link rel="stylesheet" href="../../css/loading.css">
	<style media="screen">
		.invite-con {
			width: 290px;
			background: white;
			font-size: 14px;
			color: #212121;
			text-align: center;
			border-radius: 5px;
			position: absolute;
			left: 50%;
			margin-left: -145px;
			top: 50%;
			margin-top: -185px;
		}

		.img-tip01 {
			display: block;
			width: 150px;
			margin: 0 auto;
			padding: 20px 0 10px 0;
		}

		.touch {
			font-size: 13px;
			color: #b4b4b4;
			padding: 20px 0 10px 0;
		}

		.input-box {
			padding: 0 25px;
			width: 100%;
		}

		.input-box input {
			border: 1px solid #e5e5e5;
			padding: 13px;
			width: 100%;
			border-radius: 3px;
		}

		.invite-btn {
			padding: 0 25px;
			font-size: 16px;
			margin: 11px 0 21px 0;
		}

		.invite-btn button {
			padding: 13px 10px;
			width: 100%;
			border-radius: 3px;
			color: white;
			background: #fca958;
			text-align: center;
		}

		.icon-guanbi {
			font-size: 30px;
			position: absolute;
			right: 10px;
			top: 8px;
			color: #ccc;
		}

		header {
				height: 50px;
				line-height: 50px;
				background: #ffb300;
				color: #fff;
				font-size: 18px;
				position: relative;
		}

		header em {
				width: 50px;
				height: 50px;
				background: url(../../image/back.png) no-repeat center;
				background-size: 20px;
				float: left;
		}
	</style>
</head>

<body>
	<div class="7account">
		<header>
        <em tapmode onclick="go_back()"></em> 账户设置
    </header>
		<div class="account-con">
			<div class="account-top hide">
				<img class="circle fl" src="../../image/pic.png" id="img">
				<p class="fr choice" tapmode onclick="sel_pic()">
					<span>选择头像</span>
					<i class="iconfont icon-gengduo1 icon-more"></i>
				</p>
			</div>
			<div class="msg-con hide" tapmode onclick="changeName()">
				<span class="fl">用户名</span>
				<p class="fr">
					<span style="color:#fca958;" id="nickname"></span>
					<i class="iconfont icon-gengduo1 icon-more"></i>
				</p>
			</div>
			<!-- <div class="msg-con hide" onclick="goAddress()">
				<span class="fl">收货地址</span>
				<p class="fr">
					<i class="iconfont icon-gengduo1 icon-more"></i>
				</p>
			</div> -->
			<div class="msg-con hide" tapmode onclick="changePassword()">
				<span class="fl">更改密码</span>
				<i class="iconfont icon-gengduo1 icon-more fr"></i>
			</div>
			<p class="msg-con" tapmode onclick="exitLogin()"><span style="color:#757575;">退出登录</span></p>
		</div>
	</div>


</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/my.js"></script>
<script type="text/javascript">
	var header = $api.dom('header');
	fixStatusBar_API(header);
	var id, imgUrl,token;
	apiready = function() {
		id = $api.getStorage('id'); //用户ID
		token = $api.getStorage('token');

    loading();
		getUser();
	}

	function getUser(){
			api.ajax({//获取用户基本信息
					url: serverurl,
					method: 'get',
					data: {
							values: {
									type: '10035',
									 uid: id,
								 token: token
							},
					}
			},function(ret, err){
          if (ret.status == '5') {
						ExitLogin();
          }else if (ret.status == '1') {
						if (ret.data.headimgurl) {
								$api.attr($api.dom('#img'), 'src', ret.data.headimgurl);
						}
						$api.text($api.dom('#nickname'), ret.data.nickname);
					}else {
							api.toast({
									msg: '网络错误',
									duration: 2000,
									location: 'bottom'
							});

					}
			});
	}

	//选择头像
	function sel_pic() {
		api.getPicture({
			sourceType: 'album',
			encodingType: 'jpg',
			mediaValue: 'pic',
			destinationType: 'url',
			allowEdit: true,
			quality: 50,
			saveToPhotoAlbum: false
		}, function(ret, err) {
			if (ret) {
				imgUrl = ret.data;
        if (ret.data) {
						uploader();
        }
			} else {
				console.log(JSON.stringify(err));
			}
		});
	}


	//更改密码
	function changePassword() {
		api.openWin({
			name: 'login6',
			url: '../login/login6.html',
			pageParam: {
				name: 'test'
			},
			reload:true,
			allowEdit:true
		});
	}

	//退出登录
	function exitLogin() {
		api.confirm({
		    title: '退出登录',
		    msg: '确定要退出登录吗？',
				buttons: ['确定', '取消']
		}, function(ret, err) {
			  var index = ret.buttonIndex;
				if (index == 1) {
					api.ajax({
						 url: serverurl,
						 method: 'get',
						 data: {
								 values: {
										 type:'10039',
										 uid: id
								 },
						 }
				 },function(ret, err){

						 if (ret) {
								 if (ret.status == '1') {
									 	ExitLogin();
								 }
						 } else {
								 api.toast({
										 msg: '网络错误',
										 duration: 2000,
										 location: 'bottom'
								 });
						 }
				 });
				}
		});
	}

	//获取阿里云签名
	function uploader() {
		$api.css($api.dom('#loading'), 'display:block');
		api.ajax({
			url: serverurl,
			method: 'post',
			data: {
				values: {
					type: '10033',
				},

			}
		}, function(ret, err) {

			if (ret) {
				var host = ret.host;
				var policy = ret.policy;
				var signature = ret.signature;
				var accessid = ret.accessid;
				var dir = ret.dir;
				var expire = ret.expire;
				ALIcloud(host, policy, signature, accessid, dir, expire);

			} else {

				api.toast({
					msg: '网络错误',
					duration: 2000,
					location: 'middle'
				});
			}
		});
	}

	function ALIcloud(host, policy, signature, accessid, dir, expire) {
		//将图片上传给阿里云服务器
		api.ajax({
			url: host,
			method: 'post',
			dataType: 'text',
			data: {
				values: {
					OSSAccessKeyId: accessid,
					policy: policy,
					Signature: signature,
					key: dir,
					success_action_status: 201
				},
				files: {
					file: imgUrl
				}
			}
		}, function(ret, err) {
			if (ret) {

				// 在回调函数里面调用
				var dom = parseXML(ret);
				// location 标签的内容使用DOM选择器进行查找
				var url = dom.querySelector('Location').innerHTML;

        ModifyAvatar(url);

			} else {
				api.toast({
					msg: '网络错误',
					duration: 2000,
					location: 'middle'
				});
			}
		});
	}

	//修改头像
  function ModifyAvatar(headimgurl){
			api.ajax({
			    url: serverurl,
			    method: 'get',
			    data: {
			        values: {
								  type:'10036',
			            uid: id,
									headimgurl:headimgurl,
									token:token
			        }
			    }
			},function(ret, err){
				  $api.css($api.dom('#loading'), 'display:none');

			    if (ret) {
						  if (ret.status == '5') {
									ExitLogin();
						  }else if (ret.status == '1') {
									$api.attr($api.dom('#img'), 'src', headimgurl);
									api.sendEvent({
									    name: 'ExInfo',
									    extra: {
									        key: '1',
									    }
									});

			        }else {
			        	  api.toast({
			        	      msg: '网络错误',
			        	      duration: 2000,
			        	      location: 'bottom'
			        	  });
			        }
			    } else {
						api.toast({
							msg: '网络错误',
							duration: 2000,
							location: 'bottom'
						});
			    }
			});

	}

 //修改用户名
 function changeName(){
	 var text = $api.text($api.dom('#nickname'));
	 api.prompt({
		    title:'修改用户名',
				text:text,
		    buttons: ['确定', '取消']
		}, function(ret, err) {
		    var index = ret.buttonIndex;

		    var text = ret.text;
				if (index == 1) {
					  if (!text) {
								api.toast({
								    msg: '请输入您的用户名',
								    duration: 2000,
								    location: 'middle'
								});
					  }else {
					  		Cname(text);
					  }

				}
		});

 }

function Cname(nickname){//修改用户名
	api.ajax({
		 url: serverurl,
		 method: 'get',
		 data: {
				 values: {
						 type:'10160',
						 uid: id,
						 nickname:nickname,
						 token:token
				 }
		 }
 },function(ret, err){

		 if (ret) {
			   if (ret.status == '5') {
							ExitLogin();
			   }else if (ret.status == '1') {
						 $api.text($api.byId('nickname'), nickname);
						 api.sendEvent({
								 name: 'ExInfo',
								 extra: {
										 key: '2',
								 }
						 });
				 }else {
						 api.toast({
								 msg: '网络错误',
								 duration: 2000,
								 location: 'bottom'
						 });
				 }
		 } else {
			 api.toast({
				 msg: '网络错误',
				 duration: 2000,
				 location: 'bottom'
			 });
		 }
 });
}

function goAddress(){
		api.openWin({
		    name: '6address_title',
		    url: '../mall/6address_title.html',
				reload:true
		});

}
</script>
