<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
      <title>绑定银行卡</title>
      <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
      <link rel="stylesheet" type="text/css" href="../../css/loading.css"/>
      <style>
          header {
              height: 50px;
              line-height: 50px;
              background: #ffb300;
              color: #fff;
              font-size: 18px;
              position: relative;
          }

          header em {
              width: 50px;
              height: 50px;
              background: url(../../image/back.png) no-repeat center;
              background-size: 20px;
              float: left;
          }

          .Btop{padding: 10px 10px 0 10px; background: #fff; box-shadow: 1px 1px 4px 0px rgba(0, 0, 0, 0.15);}
          .cardNum{font-size: 13px; color: #999; background: url(../../image/bankCard.png) no-repeat left center;
            background-size: 16px 13px; padding-left: 25px;}
          .entryBox{padding-top: 20px; color: #212121; font-size: 15px; height: 35px; line-height: 35px; padding-bottom: 10px;}
          .entryBox .entry{width: 63%; position: relative; border-bottom: 1px solid #f2f2f2; display: inline-block;}
          .entryBox .entry input{width: calc(100% - 20px);}
          .entryBox em{position: absolute; right: 0; width: 20px; height: 35px; background: url(../../image/close.png) no-repeat right center;
          background-size: 11px;}
          .Btop .prompt{font-size: 12px; color: #999; padding-bottom: 25px;}

          .Info{background: #fff; padding: 10px; margin-top: 10px;}
          .Info .title{font-size: 13px; color: #999; height: 15px; line-height: 15px; background: url(../../image/info.png) no-repeat left center;
          background-size: 17px 15px; padding-left: 25px;}
          .Info .form{padding: 17px 0;}
          .Info .form li{height: 35px; line-height: 35px; font-size: 15px; overflow: hidden;}
          .form li span{width: 26%; color: #212121; display: block; float: left;}
          .form li p{width: 74%; color: #757575; float: left; height: 35px;}

          .confirm{width: 92%; height: 44px; background-color: #c5c5c5; border-radius: 5px; margin: 37px 4%; font-size: 18px;
          color: #fff;}
          .confirm.on{background: #ffb300;}
      </style>
  </head>
  <body>
      <div id="wrap">
        <header>
            <em tapmode onclick="go_back()"></em> 绑定银行卡
        </header>
        <div id="main">
            <div class="Btop">
                <div class="cardNum">请输入持卡人本人的银行卡账号</div>
                <div class="entryBox">
                    卡号
                    <div class="entry">
                        <input type="text" name="" value="" id="cardNum" oninput="checkValue()" onpropertychange="checkValue()">
                        <em tapmode onclick="clearCard()"></em>
                    </div>
                </div>
                <div class="prompt">此卡会作为默认收款银行卡</div>
            </div>
            <div class="Info">
                <div class="title">个人信息</div>
                <ul class="form">
                  <li>
                      <span>姓名</span>
                      <p id="name"></p>
                  </li>
                  <li>
                      <span>身份证号码</span>
                      <p id="IdCard"></p>
                  </li>
                </ul>
            </div>
            <button class="confirm" disabled="disabled" tapmode onclick="BindCard()">完成绑定</button>
        </div>
      </div>
  </body>
  <script type="text/javascript" src="../../script/api.js"></script>
  <script type="text/javascript" src="../../script/my.js"></script>
  <script type="text/javascript">
      var header = $api.dom('header');
      fixStatusBar_API(header);
      var uid,token;
      apiready = function(){
          uid = $api.getStorage('id');
          token = $api.getStorage('token');
          loading();
          (function(){
              $api.css($api.byId('main'), 'display:none');
              $api.css($api.byId('loading'), 'display:block');
              api.ajax({//显示认证资料
                  url: serverurl,
                  method: 'get',
                  data: {
                      values: {
                          type: '10173',
                         token: token,
                          uid: uid
                      },
                  }
              },function(ret, err){

                $api.css($api.byId('loading'), 'display:none');

                  if (ret) {
                      if (ret.status == '5') {
                          ExitLogin();
                      }else {
                          $api.css($api.byId('main'), 'display:block');
                          if (!ret.status) {
                              $api.text($api.byId('name'), ret.name);
                              $api.text($api.byId('IdCard'), ret.id_card);
                          }else {
                              $api.css($api.dom('.Info'), 'display:none');
                          }
                      }

                  } else {

                      api.toast({
                          msg: '网络错误',
                          duration: 2000,
                          location: 'bottom'
                      });

                  }
              });

          }())

      };


      // 绑定银行卡
      function BindCard(){
        var time = Math.round(new Date().getTime()/1000);//当前时间戳
        var cardNum = $api.val($api.dom('#cardNum'));
        // 正则验证银行卡
        var regCard = /^([1-9]{1})(\d{14}|\d{18})$/;

        if (!regCard.test(cardNum)) {
            api.toast({
                msg: '请输入正确的银行卡号',
                duration: 2000,
                location: 'middle'
            });
            return false;

        }else {

            $api.css($api.byId('loading'), 'display:block');
            api.ajax({
                url: serverurl,
                method: 'get',
                data: {
                    values: {
                        type: '10101',
                       token: token,
                         uid:uid,
                 card_number: cardNum,
                        time:time
                    },
                }
            },function(ret, err){
                $api.css($api.byId('loading'), 'display:none');
              
                if (ret) {
                    if (ret.status == '5') {
                        ExitLogin();
                    }else if (ret.status == '1') {

                        api.toast({
                            msg: '绑定成功',
                            duration: 2000,
                            location: 'middle'
                        });

                        api.sendEvent({
                            name: 'isBind',
                            extra: {
                                key: '1',
                            }
                        });

                        api.openWin({
                            name: 'widthdraw',
                            url: './widthdraw.html',
                            pageParam: {
                                name: 'test'
                            },
                            reload:true,
                            allowEdit:true
                        });

                    }else{
                        api.toast({
                            msg: '绑定失败',
                            duration: 2000,
                            location: 'middle'
                        });
                    }
                } else {

                    api.toast({
                        msg: '网络错误',
                        duration: 2000,
                        location: 'bottom'
                    });

                }
            });
        }
      }

      //实时监测输入框输入事件
      function checkValue(){
          var cardNum = $api.val($api.dom('#cardNum'));
          if (cardNum) {
              $api.addCls($api.dom('.confirm'), 'on');
              $api.removeAttr($api.dom('.confirm'), 'disabled');
          }else {
              $api.removeCls($api.dom('.confirm'), 'on');
              $api.attr($api.dom('.confirm'), 'disabled','disabled');
          }
      }

      // 清空所输的银行卡号
      function clearCard(){
          var cardNum = $api.val($api.dom('#cardNum'),'');
          $api.removeCls($api.dom('.confirm'), 'on');
          $api.attr($api.dom('.confirm'), 'disabled','disabled');
      }
  </script>
  </html>
