<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
      <title>商品详情</title>
      <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
      <link rel="stylesheet" type="text/css" href="../../css/swiper.min.css">
      <style>
            header{position: relative; height: 44px; line-height: 44px; box-shadow: 0px 4px 4px 0px rgba(76, 81, 118, 0.15);
            font-size: 18px; background-color: #fefefe;}
            header em{height: 44px; background: url(../../image/back.png) no-repeat center 12px; background-size: 10px 17px;
            padding-left: 14px; padding-right: 30px; float: left;}
            header span{width: 18px; height: 44px; background: url(../../image/share3.png) no-repeat 0 14px; background-size: 18px;
            float: right; margin-right: 14px;}

          	/*========================底部========================*/
          	#nopay_footer {
          		width: 100%;
          		background: #fefefe;
          		border-top: 1px solid #f2f2f2;
              display: table;
          	}

          	#nopay_footer .fo_left {
              display: table-cell;
          		width: 70%;
          	}

          	#nopay_footer .fo_left .lf_txt {
          		font-size: 13px;
          		padding-left: 14px;
          		padding-right: 2%;
              padding-top: 14px;
              padding-bottom: 14px;
              color: #ffb300;
          	}

          	#nopay_footer .total-credit {
          		font-size: 16px;
          	}

            #nopay_footer .total-cash {
          		color: #999;
          	}


          	#nopay_footer .btn_pay {
          		display: table-cell;
          		width: 30%;
          		text-align: center;
          		color: #fff;
          		font-size: 18px;
          		background: #ff5252;
              position: relative;
          	}

          	#nopay_footer .btn_pay.submit {
          		background: #ffb300;
          	}
            .btn_txt{
              position: absolute;
              top: 50%;
              width: 100%;
              left: 50%;
              transform: translate(-50%,-50%);
              -webkit-transform: translate(-50%,-50%);
            }
          	/*======================底部==========================*/
            .introduce{font-size: 14px;}
          	.introduce span{margin: 0 10px; color: #ffb300; font-size: 14px;}

            .swiper-container {
               width: 100%;
               height: 300px;
             }
             .swiper-slide {
               text-align: center;
               font-size: 18px;
               background: #fefefe;

               /* Center slide text vertically */
               display: -webkit-box;
               display: -ms-flexbox;
               display: -webkit-flex;
               display: flex;
               -webkit-box-pack: center;
               -ms-flex-pack: center;
               -webkit-justify-content: center;
               justify-content: center;
               -webkit-box-align: center;
               -ms-flex-align: center;
               -webkit-align-items: center;
               align-items: center;
             }
             .swiper-slide img{width: 100%; height: 100%; display: block;}

             .g-info{background-color: #fefefe; padding: 14px; margin-bottom: 10px;}
             .g-namebox{line-height: 20px;}
             .g-name{width: 80%; font-size: 17px; float: left;}
             .g-num{width: 20%; text-align: right; color: #999; font-size: 13px; float: left;}
             .g-des{font-size: 13px; line-height: 20px; color: #999; padding-top: 4px;}
             .g-unitprice{margin-top: 12px; font-size: 13px;}
             .unit-credit{color: #ffc708;}
             .unit-credit em{font-size: 16px;}
             .unit-cash{color: #999;}
             .g-spec{margin-bottom: 10px; padding: 14px; color: #ced1d5; font-size: 16px; background-color: #fefefe;}
             .g-content{padding: 14px; background-color: #fefefe; min-height: 150px;}
             .g-ctitle{font-size: 13px; color: #ccc;}
             .g-ctitle span{width: 60px;}
             .g-ctitle em{width: calc(100% - 64px); height: 1px; background-color: #e4e4e4; vertical-align: bottom;}
             .g-cotentinfo{color: #262829; font-size: 16px; line-height: 22px; padding: 12px 0;}

             /*弹窗*/
             .Popup{width: 100%; height: 100%; background: rgba(0,0,0,.6); position: absolute; top: 0;
               left: 0; z-index: 99;}
             .PopupBox{position: absolute; bottom: 0; background-color: #fefefe; padding: 14px; width: calc(100% - 28px);}
             .sel-type{font-size: 13px; color: #ced1d5; margin-bottom: 10px;}
             .sel-close{position: absolute; font-weight: bold; font-size: 28px; right: 14px; top: 10px; color: #ced1d5;}
             .btn-type{margin-bottom: 20px;}
             .btn-type a{min-width: 92px; text-align: center; background-color: #e8eaee; border-radius: 5px; padding: 10px 0;
             font-size: 15px; color: #999; margin-right: 10px;}
             .btn-type a.on{background-color: #ffc708; color: #fff;}
             .g-numBox{text-align: center; font-size: 16px; font-weight: bold;}
             .g-numBox span{float: left; line-height: 35px; display: block;}
             .g-numBox .reduce{color: #e8eaee; width: 43px; font-size: 20px; border: 1px solid #999; border-radius: 5px 0px 0px 5px;}
             .g-numBox .sel-nums{color: #ffc708; width: 65px; border-top: solid 1px #999999; border-bottom: solid 1px #999999;
             height: 35px; float: left; text-align: center; border-radius: 0; -webkit-appearance: none;}
             .g-numBox .add{color: #999; width: 43px; font-size: 20px; border: 1px solid #999; border-radius: 0px 5px 5px 0px;}
             .sel-typebox{padding-right: 28px;}
             .Popup-btn{width: 100%; height: 44px; line-height: 44px; border-radius: 3px; background-color: #ffc708; color: #fff;
             text-align: center; margin-top: 20px; font-size: 18px;}
      </style>
  </head>
  <body>
      <div id="wrap" v-cloak>
        <header>
            <em tapmode onclick="go_back()"></em>
            商品详情
            <span tapmode onclick="Share()"></span>
        </header>
    		<div id="main">
          <!-- Swiper -->
          <div class="swiper-container" v-if="img">
            <div class="swiper-wrapper">
              <div class="swiper-slide" v-for="v in img">
                  <img :src="v" alt="商品详情图">
              </div>
            </div>
            <!-- Add Pagination -->
            <div class="swiper-pagination"></div>
          </div>

          <div class="g-info">
              <div class="g-namebox clearfix">
                  <div class="g-name">{{goodsInfo.goods_name}}</div>
                  <div class="g-num">库存:<em>{{goodsInfo.goods_number}}</em></div>
              </div>
              <p class="g-des">
                  {{goodsInfo.abs}}
              </p>
              <div class="g-unitprice">
                  <span class="unit-credit">单价:<em>{{goodsInfo.total}}</em>学分</span>
                  <span class="unit-cash">(现金:<em>{{goodsInfo.total * 0.2}}</em>元)</span>
              </div>
          </div>

          <div class="g-spec" tapmode onclick="SelGood()">
              <span>请选择商品规格</span>
          </div>

          <div class="g-content">
              <div class="g-ctitle">
                <span>商品详情</span>
                <em></em>
                <div class="g-cotentinfo" v-html="content.content">
                    
                </div>
              </div>
          </div>
    	</div>
      <!-- 底部 -->
      <div id="nopay_footer">
        <div class="fo_left">
          <span class="lf_txt">总价:
            <em class="total-credit">{{total}}学分</em>
            <em class="total-cash">(现金{{total * 0.2}}元)</em>
          </span>
        </div>
        <div class="btn_pay submit" tapmode @click="goOrder()">
            <span class="btn_txt">提交订单</span>
        </div>
      </div>

      <!-- 弹窗 -->
      <div class="Popup" style="display:none">
          <div class="PopupBox">
              <div class="sel-typebox" v-if="size">
                <p class="sel-type">
                    选择类型
                </p>
                <div class="btn-type">
                    <a class="size" href="javascript:;" v-for="(type,index) in size" tapmode @click="selType($event,type.size,index)">{{type.size}}</a>
                </div>
              </div>
              <em class="sel-close" tapmode onclick="closePopup()">&times;</em>
              <p class="sel-type">选择数量</p>
              <div class="g-numBox clearfix">
                  <span class="reduce" tapmode onclick="minus()">&#45;</span>
                  <input type="number" class="sel-nums" value="1" id="num" readonly="readonly">
                  <span class="add" tapmode onclick="add()">&#43;</span>
              </div>
              <button class="Popup-btn" tapmode onclick="Selok()">确 定</button>
          </div>
      </div>
    </div>


  </body>
  <script type="text/javascript" src="../../script/api.js"></script>
  <script type="text/javascript" src="../../script/my.js"></script>
  <script type="text/javascript" src="../../script/vue.js"></script>
  <script type="text/javascript" src="../../script/swiper.min.js"></script>
  <script type="text/javascript">

      var goodsid,gitem,numMax;
      apiready = function(){
            api.parseTapmode();
            token = api.getPrefs({
  							sync: true,
  							key: 'token'
  					});
  					id = api.getPrefs({
  							sync: true,
  							key: 'id'
  					});
            fnInitSwipe();
            goodsid = api.pageParam.goods_id;

            vm.getGoodsInfo();
            setTimeout(function(){
              var firstSize = $api.first($api.dom('.btn-type'));
              $api.addCls(firstSize, 'on');
            },100);

      };

      var vm = new Vue({
          el: '#wrap',
          data: {
              goodsInfo: [],
              content: [],
              img: [],
              size:[],
              total:''
          },
          methods: {
              goOrder:function goOrder(){

                  if (vm.size) {
                     var type = $api.text($api.dom('.g-spec span'));
                  }else {
                     var type = '';
                  }

                  var RselNum = document.getElementById("num").value;
                  var imgurl = vm.goodsInfo.imgurl;

                  var pageParam = {
                       goods_id: goodsid,
                       total:parseInt(vm.total),
                       type:type,
                       RselNum:RselNum,
                       imgurl:imgurl,
                       goods_name:vm.goodsInfo.goods_name
                  }
                  openWin('6confirmOrder','./6confirmOrder.html',pageParam);


              },
              getGoodsInfo: function getGoodsInfo() {
                  //读取商品详情
                 showProgress('努力加载中','请稍后···');

                  api.ajax({
                      url: serverurl,
                      method: 'get',
                      cache: true,
                      dataType: 'json',
                      data: {
                          values: {
                              type: '10032',
                              goodsid: goodsid,
                              uid:id
                          }
                      }
                  }, function (ret, err) {
                      api.hideProgress();

                      if (ret) {
                          vm.goodsInfo = ret.data.info;
                          vm.content = ret.data.content;
                          vm.img = ret.data.img;
                          vm.size = ret.data.size;
                          vm.total = vm.goodsInfo.total;
                          numMax = parseInt(vm.goodsInfo.goods_number);//最大值


                      } else {
                          msg('网络错误');
                      }
                  });
              },

              selType:function selType(e,item,index){
                  gitem = item;
                  var size = document.querySelectorAll(".size");
                  var firstSize = $api.first($api.dom('.btn-type'));

                  for (var i = 0; i < size.length; i++) {

                    size[i].classList.remove('on');
                    if (index != i && $api.hasCls(firstSize,'on')) {

                       $api.removeCls(firstSize, 'on');
                    }

                  }
                  $api.addCls(e.currentTarget, 'on');
              }


          }
      });

      // swiper
      function fnInitSwipe(){
        var swiper = new Swiper('.swiper-container', {
          pagination: {
            el: '.swiper-pagination',
          },
          centeredSlides: true,
          observer:true, //修改swiper自己或子元素时，自动初始化swiper
          observeParents:true,//修改swiper的父元素时，自动初始化swiper
          autoplay: {
            delay: 2500,
            disableOnInteraction: false,
          },

        });
      }

      // 选择规格
      function SelGood(){
          $api.css($api.dom('.Popup'), 'display:block');
      }

      // 关闭选择规格
      function closePopup(){
          $api.css($api.dom('.Popup'), 'display:none');

      }

      // 确定选择规则
      function Selok(){
          var selNum = document.getElementById("num").value;
          if (vm.size) {
              if (gitem) {
                  $api.html($api.dom('.g-spec'), '<span>' + gitem + '</span>' + '*' + selNum);
              }else {
                  $api.html($api.dom('.g-spec'), '<span>'+vm.size[0].size+ '</span>' + '*' + selNum);
              }
          }else {
              $api.html($api.dom('.g-spec'), '数量' + '*' + selNum);
          }

          vm.total = parseInt(vm.goodsInfo.total)*selNum;
          $api.css($api.dom('.Popup'), 'display:none');
      }

      // 数字减少
    	function minus(){
    	    var num = document.getElementById("num").value;
          var numMin = 1;
    	    if(num <= numMin){
    				document.getElementById("num").value = numMin;
    				api.toast({
    						msg: '当前已是最小购买数量',
    						duration: 2000,
    						location: 'middle'
    				});
    				return false;
    	    }else{
    	      document.getElementById("num").value--;
    	    }

    	}

      // 点击增加
    	function add(){
          var num = document.getElementById("num").value;
    	    if(num >= numMax){
    	        document.getElementById("num").value = numMax;
              msg('已达到最大购买数量');
              return false;
    	    }else{
              document.getElementById("num").value++;
    	    }
    	}

      function Share() {

          var dialogBox = api.require('dialogBox');
          dialogBox.actionMenu({
              rect: {
                  h: 150
              },
              texts: {
                  cancel: '取消'
              },
              items: [{
                  text: '朋友圈',
                  icon: 'widget://image/share2.png'
              }, {
                  text: '微信好友',
                  icon: 'widget://image/share1.png'
              }],
              styles: {
                  bg: '#FFF',
                  column: 3,
                  itemText: {
                      color: '#000',
                      size: 14,
                      marginT: 8
                  },
                  itemIcon: {
                      size: 40
                  },
                  cancel: {
                      bg: 'fs://icon.png',
                      color: '#000',
                      h: 44,
                      size: 16
                  }
              },
              tapClose: true
          }, function (ret) {

              if (ret.eventType == 'cancel') {
                  dialogBox.close({
                      dialogName: 'actionMenu'
                  });
              } else {
                  dialogBox.close({
                      dialogName: 'actionMenu'
                  });
                  if (ret.index == 0) {
                      weiShare('timeline', vm.goodsInfo.goods_name, vm.goodsInfo.abs, goodsid);//朋友圈
                  } else if (ret.index == '1') {
                      weiShare('session', vm.goodsInfo.goods_name, vm.goodsInfo.abs, goodsid);//会话
                  }
              }
          });
      }

      // 微信分享网页
      function weiShare(scene,title,content,goodsid){

          var contentUrl = 'https://wechat.123win.com.cn/xlp/mall/credit_goodDetail.html?goodsid='+goodsid+'&uid='+id;
          var wx = api.require('wx');
          wx.isInstalled(function(ret, err) {//判断当前设备是否已经安装微信
              if (ret.installed) {

                  wx.shareWebpage({
                      apiKey: '',
                      scene: scene,
                      title: title,
                      description: content,
                      thumb: 'widget://icon/icon2.png',
                      contentUrl: contentUrl
                  }, function(ret, err) {

                      if (ret.status) {
                          msg('分享成功');

                      } else {

                          console.log(err.code);

                      }
                  });
              } else {

                  msg('当前设备未安装微信客户端');

              }
          });

      }
  </script>
  </html>
