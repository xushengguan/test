<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>首页</title>
    <link rel="stylesheet" type="text/css" href="./css/api.css" />
    <style>
    .share {
        padding: 5px 0;
        height: 35px;
        line-height: 35px;
        background: #fff;
        position: relative;
        overflow: hidden;
        box-shadow: 0 3px 3px rgba(0, 0, 0, .1);
        border-bottom: 1px solid #f2f2f2;
    }

    .share .public {
        width: calc(80% - 30px);
        float: left;
        font-size: 15px;
        color: #999;
        height: 100%;
        padding: 0 15px;
    }

    .share .rt {
        width: calc(20% - 1px);
        border-left: 1px solid #d2d3d5;
        float: left;
        height: 100%;
    }

    .share .rt span {
        width: 20px;
        height: 20px;
        background: url(./image/pulic.png) no-repeat center;
        display: block;
        background-size: 20px;
        position: relative;
        top: 50%;
        margin-top: -10px;
        left: 50%;
        margin-left: -10px;
    }

    .share .rt em {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: #df2a2a;
        position: absolute;
        right: -1px;
        top: 0;
    }


   .input_box {
       padding: 5px 10px;
       position: relative;
       background: #ffb300;
       overflow: hidden;
   }
   .input_box .bg{background: #fff; overflow: hidden; border-radius: 2px;}
   .input_box input {
       width: calc(100% - 55px);
       height: 40px;
       line-height: 40px;
       background: #fff;
       color: #ccc;
       font-size: 16px;
       padding-left: 15px;
       display: block;
       float: left;
       text-align: left;
   }

   .input_box em {
       display: block;
       width: 40px;
       height: 40px;
       background: url(./image/search.png) no-repeat center;
       background-size: 16px;
       background-color: #fff;
       float: left;
   }

   .title {
       color: #fff;
       font-size: 18px;
       text-align: center;
       line-height: 50px;
       height: 50px;
       background: #ffb300;
   }
    header{ background: #ffb300;}
    header ul li:not(:first-child){display: none;}


    </style>
</head>

<body>
  <header>
      <ul>
        <li id="header1">
          <div class="input_box">
              <div class="bg">
                <input type="text" placeholder="请输入您想要搜索的内容">
                <em tapmode onclick="goSearch(this)"></em>
              </div>
          </div>

        </li>
        <li id="header2">
          <div class="input_box">
              <div class="bg">
                <input type="text" placeholder="请输入您想要搜索的内容">
                <em tapmode onclick="goSearch(this)"></em>
              </div>
          </div>
        </li>
        <li id="header3">
            <div class="title">学分商城</div>
        </li>
      </ul>
  </header>


</body>

</html>
<script type="text/javascript" src="./script/api.js"></script>
<script type="text/javascript" src="./script/my.js"></script>
<script type="text/javascript">
     var token,uid;
     var key;
    //此事件是在api对象准备完毕后产生，在每个Window或Frame的HTML代码中都需要监听此事件，以确定APICloud扩展对象已经准备完毕，可以调用了。
    apiready = function() {
        //适配iOS7+、Android4.4+系统状态栏，为传入的DOM元素增加适当的上内边距，避免header与状态栏重叠
        // $api.fixStatusBar( $api.dom('#main') );

        //设置状态栏样式为白色（适用于深色背景）或黑色（适用于浅色背景），以及设置状态栏背景颜色
        // api.setStatusBarStyle({
        //     style: 'dark',
        //     color: '#fcd058'
        // });

        $api.setStorage('SYSTEMTYPE', api.systemType);
        $api.setStorage('SYSTEMVERSION', api.systemVersion);
        $api.setStorage('FULLSCREEN', api.fullScreen);
        $api.setStorage('IOS7STATUSBARAPPEARANCE', api.iOS7StatusBarAppearance);
        token = $api.getStorage('token');
        uid = $api.getStorage('id');
        var header = $api.dom('header');
        fixStatusBar_API(header);

        focus_input();

        //监听返回
        api.addEventListener({
            name: 'keyback'
        }, function(ret, err) {
            if (daojishi == 0) {
                //这里设置了倒计时为2秒
                daojishi = 2000;
                api.toast({
                    msg: '再按一次退出',
                    duration: 2000,
                    location: 'bottom'
                });
                kaishiJishi();
            } else {
                api.closeWidget({
                    silent: false
                });
            }
        });

        var NVTabBar = api.require('NVTabBar');
        NVTabBar.open({
            styles: {
                bg: '#fff',

                h: 48,
                dividingLine: {
                    width: 0.5,
                    color: 'rgba(0, 0, 0, 0.15)'
                },

            },
            items: [{
                w: api.winWidth / 5.0,
                bg: {
                    marginB: -2,
                    image: 'rgba(0,0,0,0)'
                },
                iconRect: {
                    w: 20.0,
                    h: 20.0,
                },
                icon: {
                    normal: 'widget://image/circle.png',
                    highlight: 'widget://image/circle1.png',
                    selected: 'widget://image/circle1.png'
                },
                title: {
                    text: '学客圈',
                    size: 12.0,
                    normal: '#3f3f3f',
                    selected: '#3f3f3f',
                    marginB: 4.0
                }
            }, {
                w: api.winWidth / 5.0,
                bg: {
                    marginB: -2,
                    image: 'rgba(0,0,0,0)'
                },
                iconRect: {
                    w: 20.0,
                    h: 20.0,
                },
                icon: {
                    normal: 'widget://image/activity.png',
                    highlight: 'widget://image/activity1.png',
                    selected: 'widget://image/activity1.png'
                },
                title: {
                    text: '活动汇',
                    size: 12.0,
                    normal: '#3f3f3f',
                    selected: '#3f3f3f',
                    marginB: 4.0
                }
            }, {
                w: api.winWidth / 5.0,
                bg: {
                    marginB: 10,
                    image: 'widget://image/NVTabBar/yyuan.png' //中间背景图
                },
                iconRect: {
                    w: 60,
                    h: 60,
                },
                icon: {
                    normal: 'widget://image/scan2.png',
                    highlight: 'widget://image/scan2.png',
                    selected: 'widget://image/scan2.png'
                },
                title: {
                    //text : '333',
                    size: 0.0,
                    normal: '#3f3f3f',
                    selected: '#3f3f3f',
                    marginB: 0
                }
            }, {
                w: api.winWidth / 5.0,
                bg: {
                    marginB: -2,
                    image: 'rgba(0,0,0,0)'
                },
                iconRect: {
                    w: 20.0,
                    h: 20.0,
                },
                icon: {
                    normal: 'widget://image/mall.png',
                    highlight: 'widget://image/mall1.png',
                    selected: 'widget://image/mall1.png'
                },
                title: {
                    text: '学分商城',
                    size: 12.0,
                    normal: '#3f3f3f',
                    selected: '#3f3f3f',
                    marginB: 4.0
                }
            }, {
                w: api.winWidth / 5.0,
                bg: {
                    marginB: -2,
                    image: 'rgba(0,0,0,0)'
                },
                iconRect: {
                    w: 20.0,
                    h: 20.0,
                },
                icon: {
                    normal: 'widget://image/my.png',
                    highlight: 'widget://image/my1.png',
                    selected: 'widget://image/my1.png'
                },
                title: {
                    text: '个人中心',
                    size: 12.0,
                    normal: '#3f3f3f',
                    selected: '#3f3f3f',
                    marginB: 4.0
                }
            }],
            selectedIndex: 0
        }, function(ret, err) {


            if (ret.eventType == 'show') {

              goScircle();

            }else{
              $api.val($api.dom('#header1 input'),'');
              $api.val($api.dom('#header2 input'),'');
              if (ret.index == 1) {
                $api.css($api.dom('#header1'), 'display:none');
                $api.css($api.dom('#header3'), 'display:none');
                $api.css($api.dom('#header2'), 'display:block');
                api.openFrame({
                    name: 'stu_actLis',
                    url: './html/stu_actLis.html',
                    rect: {
                        x: 0,
                        y: $api.dom('header').offsetHeight,
                        w: api.winWidth,
                        h: api.frameHeight - $api.dom('header').offsetHeight - 50
                    },
                    pageParam: {
                        name: 'test'
                    },
                    bounces: true,
                    reload:true,
                    bgColor: 'rgba(0,0,0,0)',
                    vScrollBarEnabled: true,
                    hScrollBarEnabled: true
                });



              }else if (ret.index == 2) {
                ScanCode();

              }else if (ret.index == 3) {
                $api.css($api.dom('#header3'), 'display:block');
                $api.css($api.dom('#header1'), 'display:none');
                $api.css($api.dom('#header2'), 'display:none');
                api.openFrame({
                    name: 'frame2',
                    url: './html/frame2.html',
                    rect: {
                        x: 0,
                        y: $api.dom('header').offsetHeight,
                        w: api.winWidth,
                        h: api.frameHeight - $api.dom('header').offsetHeight - 50
                    },
                    pageParam: {
                        name: 'test'
                    },
                    bounces: true,
                    bgColor: 'rgba(0,0,0,0)',
                    vScrollBarEnabled: true,
                    hScrollBarEnabled: true
                });




              }else if (ret.index == 4) {

                api.openFrame({
                    name: 'frame4',
                    url: './html/frame4.html',
                    rect: {
                        x: 0,
                        y: 0,
                        w: api.winWidth,
                        h: api.frameHeight - 50
                    },
                    pageParam: {
                        name: 'test'
                    },
                    bounces: true,
                    bgColor: 'rgba(0,0,0,0)',
                    vScrollBarEnabled: true,
                    hScrollBarEnabled: true
                });


              }else{
                $api.css($api.dom('#header1'), 'display:block');
                $api.css($api.dom('#header2'), 'display:none');
                $api.css($api.dom('#header3'), 'display:none');
                goScircle();
              }

               api.parseTapmode();
            }

            var frames = ['frame1', 'stu_actLis','scan', 'frame2', 'frame4'];
            for (var i = 0; i < frames.length; i++) {
                if (ret.index !== i && ret.index !== 2) {
                  api.setFrameAttr({
                      name: frames[i],
                      hidden: true
                  });
                }
            }
            NVTabBar.bringToFront();

        });

    }

    var daojishi = 0;
    //倒计时
    function kaishiJishi() {
        if (daojishi > 0) {
            setTimeout(function() {
                daojishi = daojishi - 20;
                kaishiJishi();
            }, 20);
        }
    }

    // 跳到发表学客圈
    function goPubilsh(){
        api.openWin({
            name: 'circlePublish',
            url: './html/circle/circlePublish.html',
            pageParam: {

            },
            reload:true
        });

    }

    // 解决底部模块遮住输入框的bug
    function focus_input(){
        var h = document.body.scrollHeight;
        var NVTabBar = api.require('NVTabBar');
        window.onresize = function() {
          if (document.body.scrollHeight < h) {
            NVTabBar.hide({
              animation:false
            });
          } else {
            NVTabBar.show({
            animation:false
            });
          }
        };
    }

    //  跳到消息列表
    function goNews(){
        api.openWin({
            name: 'circleNews',
            url: './html/circle/circleNews.html',
            pageParam: {

            }
        });
    }

    // 打开学客圈
    function goScircle(){
        api.openFrame({
            name: 'frame1',
            url: './html/frame1.html',
            rect: {
                x: 0,
                y: $api.dom('header').offsetHeight,
                w: api.winWidth,
                h: api.frameHeight - $api.dom('header').offsetHeight - 50
            },
            pageParam: {
                name: 'test'
            },
            reload: true,
            allowEdit:true,
            softInputMode:'resize',
            bounces: true,
            bgColor: 'rgba(0,0,0,0)',
            vScrollBarEnabled: true,
            hScrollBarEnabled: true
        });
    }

    // 扫描二维码
    function ScanCode(){
      var FNScanner = api.require('FNScanner');
      FNScanner.openScanner({
          autorotation: true
      }, function(ret, err) {

          if (ret) {

              if (ret.eventType == 'success') {

                  if (ret.content.indexOf("123win.com.cn/s/") >= 0) {
                      key = ret.content.substr(-4);
                      getActInfo();
                  }else {
                      api.toast({
                          msg: '二维码不正确',
                          duration: 2000,
                          location: 'middle'
                      });

                  }


              }else if (ret.eventType == 'fail') {
                  api.toast({
                      msg: '扫描失败',
                      duration: 2000,
                      location: 'middle'
                  });

              }
          } else {
              api.toast({
                  msg: err,
                  duration: 2000,
                  location: 'bottom'
              });
          }
      });
    }

    // 弹出层领取学分
    function flexed(score){
      var dialogBox = api.require('dialogBox');
      dialogBox.raffle({
          texts: {
              mainText: '恭喜您，您有'+score+'学分可领取',
              subText: '请在活动结束后24小时内领取',
              leftTitle: '点击领取',
          },
          styles: {
              bg: '#fff',
              w: 300,
              icon: {
                  marginT: 15,
                  w: 60,
                  h: 60,
                  iconPath: 'widget://image/gift.png'
              },
              main: {
                  marginT: 15,
                  color: '#ffb300',
                  size: 20
              },
              sub: {
                  marginT: 8,
                  color: '#999999',
                  size: 12
              },
              left: {
                  marginB: 8,
                  marginL: 15,
                  w: 270,
                  h: 35,
                  corner: 2,
                  bg: '#ffb300',
                  color: '#fff',
                  size: 16
              },

          },
          tapClose:true
      }, function(ret, err) {
          if (ret) {

              if (ret.eventType == 'left') {
                  dialogBox.close({
                      dialogName: 'raffle'
                  });
                  getCredit();
              }

          } else {

              api.toast({
                  msg: '网络错误',
                  duration: 2000,
                  location: 'bottom'
              });

          }
      });

    }

    // 家长端扫码时显示活动信息
    function getActInfo(){

        api.ajax({
            url: serverurl,
            method: 'get',
            data: {
                values: {
                    type: '10178',
                    token:token,
                    key:key
                },
            }
        },function(ret, err){

            if (ret) {
                if (ret.status == '0') {
                    api.toast({
                        msg: '抱歉，没有手环信息',
                        duration: 2000,
                        location: 'middle'
                    });

                }else {
                    flexed(ret.score);
                }

            } else {

                api.toast({
                    msg: '网络错误',
                    duration: 2000,
                    location: 'bottom'
                });

            }
        });

    }

    // 点击领取学分
    function getCredit(){

      api.ajax({
          url: serverurl,
          method: 'get',
          data: {
              values: {
                  type: '10155',
                  token:token,
                  key:key,
                  uid:uid
              },
          }
      },function(ret, err){

          if (ret) {
              if (ret.status == '1') {
                  api.toast({
                      msg: '领取成功',
                      duration: 2000,
                      location: 'middle'
                  });
              }else if (ret.status == '2') {
                  api.toast({
                      msg: '抱歉，领取时间已过，学分已过期',
                      duration: 2000,
                      location: 'middle'
                  });
              }else if (ret.status == '3') {
                  api.toast({
                      msg: '抱歉，没有可领取的学分',
                      duration: 2000,
                      location: 'middle'
                  });
              }else if (ret.status == '6') {
                  api.toast({
                      msg: '抱歉，您已绑定过手环',
                      duration: 2000,
                      location: 'middle'
                  });

              }else if (ret.status == '4') {
                api.toast({
                    msg: '抱歉，您不是手环持有者',
                    duration: 2000,
                    location: 'middle'
                });

              }else{
                  api.toast({
                      msg: '领取失败',
                      duration: 2000,
                      location: 'middle'
                  });

              }

          } else {

              api.toast({
                  msg: '网络错误',
                  duration: 2000,
                  location: 'bottom'
              });

          }
      });

    }

    // 搜索
    function goSearch(e){
        var text = $api.val($api.prev(e));

        api.openWin({
            name: 'search',
            url: './html/setting/search.html',
            pageParam: {
                text: text
            }
        });

    }
</script>
